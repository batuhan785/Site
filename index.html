<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Öğrenci Portalı</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins','Segoe UI',sans-serif;}
:root {
  --primary-dark: #1e3a8a;
  --accent-warning: #f59e0b;
  --accent-danger: #dc2626;
  --accent-success: #059669;
  --bg-dark: #0f172a;
  --bg-card: #1e293b;
  --text-light: #f8fafc;
  --border-color: #334155;
}
body{background:linear-gradient(135deg, var(--bg-dark), #1e3a8a, #0f766e);color:var(--text-light);min-height:100vh;overflow-x:hidden;}
.login-modal{display:flex;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);align-items:center;justify-content:center;}
.login-content{background:var(--bg-card);padding:30px;border-radius:15px;width:90%;max-width:400px;border:2px solid var(--accent-warning);text-align:center;}
.login-content h2{margin-bottom:20px;color:var(--accent-warning);}
.login-content input{padding:12px;margin:10px 0;width:100%;border-radius:8px;border:1px solid var(--accent-warning);background:rgba(255,255,255,0.1);color:white;}
.login-btn{background:linear-gradient(135deg,var(--accent-warning),var(--accent-danger));color:white;border:none;padding:12px;width:100%;border-radius:8px;cursor:pointer;margin-top:10px;font-size:16px;}
header{background:rgba(15, 23, 42, 0.9);padding:14px 18px;display:flex;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.5);position:sticky;top:0;z-index:100;backdrop-filter:blur(8px);border-bottom:1px solid var(--border-color);}
.menu-btn{font-size:24px;cursor:pointer;margin-right:12px;color:var(--accent-warning);}
.header-title{flex:1;text-align:center;font-size:1.45rem;font-weight:600;}
.user-info{margin-left:auto;font-size:0.9rem;color:var(--accent-warning);text-align:right;cursor:pointer;}
.user-info small{display:block;font-size:0.7rem;color:#ccc;}
.sidebar{width:260px;background:var(--bg-card);position:fixed;top:0;left:-260px;height:100%;padding-top:70px;transition:left .3s ease;z-index:200;overflow-y:auto;backdrop-filter:blur(10px);border-right:1px solid var(--border-color);}
.sidebar.active{left:0;}
.sidebar a{display:block;color:var(--text-light);padding:15px 20px;text-decoration:none;border-bottom:1px solid var(--border-color);}
.sidebar a:hover{background:rgba(245,158,11,0.15);}
.overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:150;}
.overlay.active{display:block;}
.container{padding:22px;max-width:1100px;margin:0 auto;}
.countdown-container{width:100%;background:var(--bg-card);border-radius:18px;padding:26px;margin-bottom:26px;box-shadow:0 10px 30px rgba(0,0,0,0.28);border:1px solid var(--border-color);text-align:center;}
.countdown-title{font-size:1.75rem;margin-bottom:18px;font-weight:700;color:var(--accent-warning);}
.countdown-row{display:flex;gap:14px;justify-content:center;margin-bottom:10px;}
.countdown-item{background:rgba(255,255,255,0.08);padding:18px 12px;border-radius:14px;display:flex;flex-direction:column;align-items:center;min-width:64px;border:1px solid var(--border-color);}
.countdown-item span.value{font-size:2.1rem;font-weight:800;color:var(--accent-warning);}
.countdown-item label{margin-top:6px;font-size:0.95rem;color:rgba(255,255,255,0.92);}
.holiday-info{font-size:1.05rem;margin-top:16px;color:var(--accent-warning);font-weight:600;}
.content{display:none;animation:fadeIn .4s ease;}
.content.active{display:block;}
.card{background:var(--bg-card);padding:22px;margin:18px 0;border-radius:14px;border:1px solid var(--border-color);position:relative;}
.card h3{margin-bottom:12px;font-size:1.35rem;border-left:6px solid var(--accent-warning);padding-left:12px;}
.delete-btn{position:absolute;top:12px;right:12px;background:var(--accent-danger);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;color:white;}
.add-btn{position:fixed;bottom:28px;right:22px;width:68px;height:68px;border-radius:50%;background:linear-gradient(135deg,var(--accent-warning),var(--accent-danger));display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;z-index:120;box-shadow:0 4px 20px rgba(245, 158, 11, 0.3);border:none;color:white;}
input,select,textarea{padding:14px;width:100%;border-radius:10px;margin-bottom:14px;background:var(--bg-card);color:white;border:1px solid var(--border-color);}
button{background:linear-gradient(135deg,var(--accent-warning),var(--accent-danger));color:white;border:none;padding:12px;width:100%;border-radius:10px;font-size:15px;cursor:pointer;}
.modal{display:none;position:fixed;z-index:300;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);align-items:center;justify-content:center;}
.modal-content{background-color:var(--bg-card);padding:25px;border-radius:12px;width:90%;max-width:500px;border:1px solid var(--border-color);backdrop-filter:blur(10px);}
.close{color:var(--accent-warning);float:right;font-size:28px;font-weight:bold;cursor:pointer;}
#upcomingList li{margin:10px 0;padding:12px;background:rgba(255,255,255,0.06);border-radius:8px;list-style:none;}

/* ÖNEM PUANI STİLLERİ */
.importance-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;font-size:0.8rem;margin-left:8px;}
.importance-1{background:#6b7280; color:white;}
.importance-2{background:#3b82f6; color:white;}
.importance-3{background:#f59e0b; color:black;}
.importance-4{background:#ef4444; color:white;}
.importance-5{background:#dc2626; color:white;}
.urgent-card{border-left:6px solid var(--accent-danger) !important;background:linear-gradient(135deg, var(--bg-card), rgba(220, 38, 38, 0.1)) !important;}

/* SIRALAMA SİSTEMİ */
.sorting-controls {display:flex;gap:10px;margin-bottom:20px;align-items:center;flex-wrap:wrap;}
.sort-option {background:rgba(255,255,255,0.1);border:1px solid var(--border-color);padding:8px 16px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;font-size:0.9rem;}
.sort-option.active {background:linear-gradient(135deg,var(--accent-warning),var(--accent-danger));border-color:var(--accent-warning);}
.sort-option:hover {background:rgba(245,158,11,0.2);}

/* Sınav Konuları Özel Stilleri */
.exam-topics-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;}
.exam-topics-header h2 {margin:0;}
.add-topic-btn {background:linear-gradient(135deg,#16a34a,#059669);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:5px;}
.exam-card {background:var(--bg-card);border-radius:12px;margin-bottom:15px;border:1px solid var(--border-color);overflow:hidden;}
.exam-header {background:linear-gradient(135deg,var(--accent-warning),var(--accent-danger));padding:15px 20px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.exam-header h3 {margin:0;font-size:1.2rem;}
.exam-header .toggle-icon {transition:transform 0.3s ease;}
.exam-header.active .toggle-icon {transform:rotate(180deg);}
.exam-topics {padding:0;max-height:0;overflow:hidden;transition:max-height 0.3s ease,padding 0.3s ease;}
.exam-topics.active {padding:15px 20px;max-height:1000px;}
.topic-item {padding:10px;margin:8px 0;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid var(--accent-success);}
.topic-item:last-child {margin-bottom:0;}
.topics-input-container {margin-bottom:15px;}
.topic-input-group {display:flex;gap:10px;margin-bottom:10px;align-items:center;}
.topic-input {flex:1;}
.add-topic-input-btn {background:#3b82f6;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;width:auto;font-size:12px;}
.remove-topic-btn {background:var(--accent-danger);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;width:auto;font-size:12px;}

/* POMODORO STİLLERİ */
.pomodoro-container {
  background: var(--bg-card);
  border-radius: 18px;
  padding: 26px;
  margin-bottom: 26px;
  border: 1px solid var(--border-color);
  text-align: center;
}

.pomodoro-timer {
  font-size: 4rem;
  font-weight: 800;
  color: var(--accent-warning);
  margin: 20px 0;
  font-family: 'Courier New', monospace;
}

.pomodoro-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.pomodoro-btn {
  background: linear-gradient(135deg, var(--accent-warning), var(--accent-danger));
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.pomodoro-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.pomodoro-btn:disabled {
  background: #6b7280;
  cursor: not-allowed;
  transform: none;
}

.time-options {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}

.time-option {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid var(--border-color);
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.time-option.active {
  background: linear-gradient(135deg, var(--accent-warning), var(--accent-danger));
  border-color: var(--accent-warning);
}

.pomodoro-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.05);
  padding: 15px;
  border-radius: 10px;
  border: 1px solid var(--border-color);
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent-warning);
  display: block;
}

.stat-label {
  font-size: 0.8rem;
  color: #94a3b8;
  display: block;
  margin-top: 5px;
}

/* SEVİYE SİSTEMİ */
.level-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  margin-left: 8px;
}

.xp-bar {
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  margin: 8px 0;
  overflow: hidden;
}

.xp-progress {
  height: 100%;
  background: linear-gradient(90deg, #10b981, #34d399);
  border-radius: 4px;
  transition: width 0.5s ease;
}

.leaderboard-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  margin: 8px 0;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border-left: 4px solid var(--accent-warning);
}

.leaderboard-rank {
  font-weight: 700;
  font-size: 1.2rem;
  color: var(--accent-warning);
  min-width: 30px;
  text-align: center;
}

.leaderboard-info {
  flex: 1;
}

.leaderboard-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.leaderboard-level {
  font-size: 0.8rem;
  color: #94a3b8;
}

.leaderboard-xp {
  font-weight: 700;
  color: var(--accent-warning);
}

/* Öğrenci kartlarında seviye gösterimi */
.student-level {
  display: inline-block;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  margin-left: 8px;
}

.student-item {
  padding: 12px;
  margin: 8px 0;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  border-left: 4px solid var(--accent-warning);
}

/* İkili liderlik stilleri */
.leaderboard-section {
  margin-bottom: 30px;
}

.leaderboard-section h3 {
  color: var(--accent-warning);
  margin-bottom: 15px;
  border-left: 4px solid var(--accent-warning);
  padding-left: 10px;
}

.monthly-badge {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  margin-left: 8px;
}

.total-badge {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  margin-left: 8px;
}

/* STREAK STİLLERİ */
.streak-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: bold;
  color: white;
  margin-left: 8px;
}

@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
</style>
</head>
<body>

<!-- Giriş Modalı -->
<div id="loginModal" class="login-modal">
  <div class="login-content">
    <h2>Öğrenci Girişi</h2>
    <input type="text" id="studentName" placeholder="Adınız">
    <input type="text" id="studentSurname" placeholder="Soyadınız">
    <button class="login-btn" id="loginBtn">Giriş Yap</button>
    <small>Bilgileriniz kaydedilecektir.</small>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<header>
  <div class="menu-btn" id="menuBtn"><i class="fas fa-bars"></i></div>
  <div class="header-title">Öğrenci Portalı</div>
  <div class="user-info" id="userInfo" style="display:none;">Hoş geldiniz<br><small id="userName"></small></div>
</header>

<div class="sidebar" id="sidebar">
  <a href="#" data-section="home"><i class="fas fa-home"></i> Ana Sayfa</a>
  <a href="#" data-section="exams"><i class="fas fa-file-alt"></i> Sınavlar</a>
  <a href="#" data-section="homeworks"><i class="fas fa-tasks"></i> Ödevler</a>
  <a href="#" data-section="hadis"><i class="fas fa-book"></i> Hadis-i Şerifler</a>
  <a href="#" data-section="class"><i class="fas fa-users"></i> Sınıf Listesi</a>
  <a href="#" data-section="examTopics"><i class="fas fa-list-alt"></i> Sınav Konuları</a>
  <a href="#" data-section="pomodoro"><i class="fas fa-clock"></i> Pomodoro Timer</a>
  <a href="#" data-section="leaderboard"><i class="fas fa-trophy"></i> Liderlik Tablosu</a>
  <a href="#" id="adminSwitch"><i class="fas fa-user-shield"></i> Admin Profiline Geçiş Yap</a>
</div>

<div class="container">
  <div id="home" class="content active">
    <div class="countdown-container">
      <div class="countdown-title">1. Dönem Ara Tatiline Kalan Süre</div>
      <div class="countdown-row">
        <div class="countdown-item"><span id="days" class="value">00</span><label>Gün</label></div>
        <div class="countdown-item"><span id="hours" class="value">00</span><label>Saat</label></div>
        <div class="countdown-item"><span id="minutes" class="value">00</span><label>Dakika</label></div>
        <div class="countdown-item"><span id="seconds" class="value">00</span><label>Saniye</label></div>
      </div>
      <div class="holiday-info">7-14 Kasım 2025</div>
    </div>
    <div class="card">
      <h3>Hoş Geldiniz!</h3>
      <p id="welcomeMessage">Sol üstten menüye tıklayarak diğer bölümlere erişebilirsiniz.</p>
    </div>
    
    <!-- YAKLAŞAN SINAVLAR/ÖDEVLER -->
    <div class="card" id="upcomingCard">
      <h3>Yaklaşan Sınavlar/Ödevler (2 Gün Kalanlar)</h3>
      <ul id="upcomingList"><li>Yaklaşan sınav veya ödev bulunmamaktadır.</li></ul>
    </div>
  </div>

  <div id="exams" class="content">
    <h2 class="countdown-title">Sınavlar</h2>
    <div class="sorting-controls" id="examSorting">
      <div class="sort-option active" data-sort="importance-date">Öneme Göre (Yüksek→Düşük)</div>
      <div class="sort-option" data-sort="date">Tarihe Göre (Yakın→Uzak)</div>
      <div class="sort-option" data-sort="importance">Sadece Önem Seviyesi</div>
    </div>
    <div id="examList"></div>
  </div>

  <div id="homeworks" class="content">
    <h2 class="countdown-title">Ödevler</h2>
    <div id="homeworkList"></div>
  </div>

  <div id="hadis" class="content">
    <h2 class="countdown-title">Hadis-i Şerifler</h2>
    <div id="hadisList">
      <div class="card"><p>Henüz hadis eklenmedi.</p></div>
    </div>
  </div>

  <div id="class" class="content">
    <h2 class="countdown-title">Sınıf Listesi</h2>
    <div class="card">
      <div class="class-list" id="classList"><p>Sınıf listesi yükleniyor...</p></div>
    </div>
  </div>
  
  <div id="examTopics" class="content">
    <div class="exam-topics-header">
      <h2 class="countdown-title">Sınav Konuları</h2>
      <button id="addExamTopicBtn" class="add-topic-btn" style="display:none;">
        <i class="fas fa-plus"></i> Konu Ekle
      </button>
    </div>
    <div id="examTopicsList">
      <div class="card"><p>Henüz sınav konusu eklenmedi.</p></div>
    </div>
  </div>

  <!-- POMODORO TIMER BÖLÜMÜ -->
  <div id="pomodoro" class="content">
    <div class="pomodoro-container">
      <h2 class="countdown-title">Pomodoro Timer</h2>
      
      <div class="time-options">
        <div class="time-option active" data-minutes="30">30 Dakika</div>
        <div class="time-option" data-minutes="60">60 Dakika</div>
        <div class="time-option" data-minutes="90">90 Dakika</div>
      </div>
      
      <div class="pomodoro-timer" id="pomodoroTimer">30:00</div>
      
      <div class="pomodoro-controls">
        <button class="pomodoro-btn" id="startPomodoro">Başlat</button>
        <button class="pomodoro-btn" id="pausePomodoro" disabled>Duraklat</button>
        <button class="pomodoro-btn" id="resetPomodoro">Sıfırla</button>
      </div>
      
      <div class="pomodoro-stats">
        <div class="stat-card">
          <span class="stat-value" id="totalStudyTime">0</span>
          <span class="stat-label">Toplam Çalışma (dk)</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="currentLevel">1</span>
          <span class="stat-label">Seviye</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="currentXP">0</span>
          <span class="stat-label">XP</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="currentStreak">0</span>
          <span class="stat-label">Üst Üste Gün</span>
        </div>
      </div>

      <div class="xp-bar">
        <div class="xp-progress" id="xpProgress" style="width: 0%"></div>
      </div>
      <small>Sonraki seviye: <span id="nextLevelXP">250</span> XP</small>
    </div>
  </div>

  <!-- LİDERLİK TABLOSU BÖLÜMÜ -->
  <div id="leaderboard" class="content">
    <!-- AYLIK LİDERLİK -->
    <div class="card">
      <h2 class="countdown-title">🏆 AYLIK LİDERLİK</h2>
      <p>Bu ayki çalışma performansı - Her ayın 1'inde sıfırlanır</p>
      <div id="monthlyLeaderboard">
        <div class="leaderboard-item">
          <div class="leaderboard-rank">1</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">Örnek Öğrenci <span class="monthly-badge">Bu Ay</span></div>
            <div class="leaderboard-level">0 XP • 0 dakika</div>
          </div>
          <div class="leaderboard-xp">🥇</div>
        </div>
      </div>
    </div>

    <!-- TOPLAM LİDERLİK -->
    <div class="card">
      <h2 class="countdown-title">⭐ TÜM ZAMANLAR LİDERLİĞİ</h2>
      <p>Kariyer performansı - Kalıcı istatistikler</p>
      <div id="totalLeaderboard">
        <div class="leaderboard-item">
          <div class="leaderboard-rank">1</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">Örnek Öğrenci <span class="total-badge">Seviye 1</span></div>
            <div class="leaderboard-level">0 XP • 0 dakika</div>
          </div>
          <div class="leaderboard-xp">⭐</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="add-btn" id="addBtn"><i class="fas fa-plus"></i></div>

<div id="addModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeAddModal">&times;</span>
    <h2>Yeni İçerik Ekle</h2>
    <select id="contentType">
      <option value="exam">Sınav</option>
      <option value="homework">Ödev</option>
      <option value="hadis">Hadis-i Şerif</option>
    </select>
    <input type="text" id="contentTitle" placeholder="Başlık">
    <textarea id="contentDesc" placeholder="Açıklama"></textarea>
    <input type="datetime-local" id="contentDate">
    <div id="importanceContainer">
      <select id="contentImportance">
        <option value="1">⭐ Düşük Önem</option>
        <option value="2">⭐⭐ Orta Önem</option>
        <option value="3" selected>⭐⭐⭐ Yüksek Önem</option>
        <option value="4">⭐⭐⭐⭐ Çok Yüksek</option>
        <option value="5">⭐⭐⭐⭐⭐ KRİTİK</option>
        <option value="0">Bu alan için kullanılmıyor</option>
      </select>
    </div>
    <button id="saveContentBtn">Kaydet</button>
  </div>
</div>

<!-- Sınav Konuları Ekleme Modalı -->
<div id="addTopicModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeTopicModal">&times;</span>
    <h2>Yeni Sınav Konusu Ekle</h2>
    <select id="topicExamSelect">
      <option value="">Sınav Seçin</option>
    </select>
    
    <div class="topics-input-container">
      <div id="topicsInputs">
        <div class="topic-input-group">
          <input type="text" class="topic-input" placeholder="Konu başlığı">
          <button type="button" class="remove-topic-btn" onclick="removeTopicInput(this)" style="display:none;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <button type="button" class="add-topic-input-btn" id="addTopicInputBtn">
        <i class="fas fa-plus"></i> Konu Ekle (Maksimum: 10)
      </button>
    </div>
    
    <button id="saveTopicBtn">Kaydet</button>
  </div>
</div>

<script>
  // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCQdXsTb6BwH6grbDndGIikibjk-PtkfuI",
  authDomain: "ogrenciportali-3556c.firebaseapp.com",
  projectId: "ogrenciportali-3556c",
  storageBucket: "ogrenciportali-3556c.firebasestorage.app",
  messagingSenderId: "796688422959",
  appId: "1:796688422959:web:58ba81eb06b6a704ba0eda"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
  // Firebase Firestore'u import et ve başlat
import { getFirestore } from "firebase/firestore";
const db = getFirestore(app);
// Önem seviyeleri
const importanceLevels = {
    1:{label:"Düşük", icon:"⭐", class:"importance-1"},
    2:{label:"Orta", icon:"⭐⭐", class:"importance-2"},
    3:{label:"Yüksek", icon:"⭐⭐⭐", class:"importance-3"},
    4:{label:"Çok Yüksek", icon:"⭐⭐⭐⭐", class:"importance-4"},
    5:{label:"KRİTİK", icon:"⭐⭐⭐⭐⭐", class:"importance-5"},
    0:{label:"Kullanılmıyor", icon:"", class:"importance-1"}
};

// STREAK RENK SİSTEMİ
const streakColors = {
    1: "#6b7280", 3: "#f59e0b", 7: "#ef4444", 14: "#dc2626", 
    30: "#7c3aed", 60: "#10b981", 90: "#06b6d4"
};

// Veri yapıları
let students = [], currentUser = null, isAdmin = false, nextId = 100;
let exams = [], homeworks = [], hadises = [], examTopics = [];
let userStats = {};

// Sıralama durumu
let examSortType = "importance-date";

// Pomodoro ve Seviye Sistemi Verileri
let pomodoroInterval = null;
let currentTime = 30 * 60;
let isRunning = false;
let selectedTime = 30;
let earnedXP = 0;
let startTime = null;

// DOM Elementleri
const loginModal = document.getElementById('loginModal');
const loginBtn = document.getElementById('loginBtn');
const studentName = document.getElementById('studentName');
const studentSurname = document.getElementById('studentSurname');
const userInfo = document.getElementById('userInfo');
const userName = document.getElementById('userName');
const welcomeMessage = document.getElementById('welcomeMessage');
const sidebar = document.getElementById('sidebar');
const menuBtn = document.getElementById('menuBtn');
const overlay = document.getElementById('overlay');
const sections = document.querySelectorAll('.content');
const sidebarLinks = document.querySelectorAll('.sidebar a[data-section]');
const addBtn = document.getElementById('addBtn');
const addModal = document.getElementById('addModal');
const closeAddModal = document.getElementById('closeAddModal');
const saveContentBtn = document.getElementById('saveContentBtn');
const adminSwitch = document.getElementById('adminSwitch');
const contentTypeSelect = document.getElementById('contentType');
const importanceContainer = document.getElementById('importanceContainer');

// Sınav konuları DOM
const examTopicsList = document.getElementById('examTopicsList');
const addTopicModal = document.getElementById('addTopicModal');
const closeTopicModal = document.getElementById('closeTopicModal');
const saveTopicBtn = document.getElementById('saveTopicBtn');
const topicExamSelect = document.getElementById('topicExamSelect');
const addExamTopicBtn = document.getElementById('addExamTopicBtn');
const addTopicInputBtn = document.getElementById('addTopicInputBtn');
const topicsInputs = document.getElementById('topicsInputs');

// Sıralama DOM
const examSorting = document.getElementById('examSorting');

// Pomodoro DOM
const pomodoroTimer = document.getElementById('pomodoroTimer');
const startPomodoro = document.getElementById('startPomodoro');
const pausePomodoro = document.getElementById('pausePomodoro');
const resetPomodoro = document.getElementById('resetPomodoro');
const timeOptions = document.querySelectorAll('.time-option');
const totalStudyTimeEl = document.getElementById('totalStudyTime');
const currentLevel = document.getElementById('currentLevel');
const currentXP = document.getElementById('currentXP');
const currentStreakEl = document.getElementById('currentStreak');
const xpProgress = document.getElementById('xpProgress');
const nextLevelXP = document.getElementById('nextLevelXP');

// Liderlik DOM
const monthlyLeaderboard = document.getElementById('monthlyLeaderboard');
const totalLeaderboard = document.getElementById('totalLeaderboard');

// 🔥 FIREBASE FONKSİYONLARI
class FirebaseStorage {
    static async saveData(collectionName, data) {
        try {
            // Önce localStorage'a kaydet (offline destek)
            localStorage.setItem(collectionName, JSON.stringify(data));
            
            // Firebase'e kaydet
            await db.collection(collectionName).doc('data').set({ 
                data: data,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log('✅ Firebase kaydedildi:', collectionName);
            return true;
        } catch (error) {
            console.log('❌ Firebase kayıt hatası:', error);
            return true; // localStorage başarılı oldu
        }
    }

    static async loadData(collectionName) {
        try {
            // Önce Firebase'den yükle
            const doc = await db.collection(collectionName).doc('data').get();
            if (doc.exists) {
                const firebaseData = doc.data().data;
                localStorage.setItem(collectionName, JSON.stringify(firebaseData));
                console.log('✅ Firebase yüklendi:', collectionName);
                return firebaseData;
            }
        } catch (error) {
            console.log('❌ Firebase yükleme hatası:', error);
        }
        
        // Firebase'den yüklenemezse localStorage'dan yükle
        const localData = localStorage.getItem(collectionName);
        return localData ? JSON.parse(localData) : [];
    }

    // Gerçek zamanlı dinleme
    static listenForChanges(collectionName, callback) {
        return db.collection(collectionName).doc('data')
            .onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data().data;
                    localStorage.setItem(collectionName, JSON.stringify(data));
                    console.log('🔄 Gerçek zamanlı güncelleme:', collectionName);
                    callback(data);
                }
            });
    }
}

// 📥 TÜM VERİLERİ YÜKLE
async function loadAllData() {
    try {
        students = await FirebaseStorage.loadData('students') || [];
        exams = await FirebaseStorage.loadData('exams') || [];
        homeworks = await FirebaseStorage.loadData('homeworks') || [];
        hadises = await FirebaseStorage.loadData('hadises') || [];
        examTopics = await FirebaseStorage.loadData('examTopics') || [];
        userStats = await FirebaseStorage.loadData('userStats') || {};
        
        console.log('✅ Tüm veriler yüklendi');
    } catch (error) {
        console.log('❌ Veri yükleme hatası:', error);
    }
    
    renderAll();
}

// 📤 TÜM VERİLERİ KAYDET
async function saveAllData() {
    try {
        await Promise.all([
            FirebaseStorage.saveData('students', students),
            FirebaseStorage.saveData('exams', exams),
            FirebaseStorage.saveData('homeworks', homeworks),
            FirebaseStorage.saveData('hadises', hadises),
            FirebaseStorage.saveData('examTopics', examTopics),
            FirebaseStorage.saveData('userStats', userStats)
        ]);
    } catch (error) {
        console.log('❌ Veri kaydetme hatası:', error);
    }
}

// 🎯 GERÇEK ZAMANLI SİNC
function startRealTimeSync() {
    FirebaseStorage.listenForChanges('exams', (newExams) => {
        exams = newExams;
        renderExams();
    });
    
    FirebaseStorage.listenForChanges('homeworks', (newHomeworks) => {
        homeworks = newHomeworks;
        renderHomeworks();
    });
    
    FirebaseStorage.listenForChanges('hadises', (newHadises) => {
        hadises = newHadises;
        renderHadis();
    });
}

// 🏃‍♂️ UYGULAMAYI BAŞLAT
window.addEventListener('load', async () => {
    await loadAllData();
    startRealTimeSync();
    startCountdown();
    renderLeaderboards();
    checkMonthlyReset();
});

// Aylık sıfırlama kontrolü
function checkMonthlyReset() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    const lastReset = localStorage.getItem('lastMonthlyReset');
    
    if (!lastReset) {
        resetMonthlyStats();
        localStorage.setItem('lastMonthlyReset', `${currentYear}-${currentMonth}`);
        return;
    }
    
    const [lastYear, lastMonth] = lastReset.split('-').map(Number);
    
    if (currentYear > lastYear || (currentYear === lastYear && currentMonth > lastMonth)) {
        resetMonthlyStats();
        localStorage.setItem('lastMonthlyReset', `${currentYear}-${currentMonth}`);
    }
}

function resetMonthlyStats() {
    Object.keys(userStats).forEach(userKey => {
        if (userStats[userKey]) {
            userStats[userKey].monthlyXP = 0;
            userStats[userKey].monthlyStudyTime = 0;
            userStats[userKey].monthlySessions = 0;
        }
    });
    saveAllData();
}

// STREAK RENGİ ALMA
function getStreakColor(streak) {
    if (streak >= 90) return streakColors[90];
    if (streak >= 60) return streakColors[60];
    if (streak >= 30) return streakColors[30];
    if (streak >= 14) return streakColors[14];
    if (streak >= 7) return streakColors[7];
    if (streak >= 3) return streakColors[3];
    return streakColors[1];
}

// STREAK GÜNCELLEME
function updateStreak() {
    if (!currentUser) return;
    
    const userKey = `${currentUser.name}_${currentUser.surname}`;
    const stats = userStats[userKey];
    if (!stats) return;
    
    const today = new Date().toDateString();
    const lastStudy = stats.lastStudyDate ? new Date(stats.lastStudyDate).toDateString() : null;
    
    const todayStudy = (stats.dailyStudyTime || 0) > 0;
    
    if (todayStudy) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toDateString();
        
        if (lastStudy === yesterdayStr) {
            stats.currentStreak = (stats.currentStreak || 0) + 1;
        } else if (lastStudy !== today) {
            stats.currentStreak = 1;
        }
        
        if (stats.currentStreak > (stats.longestStreak || 0)) {
            stats.longestStreak = stats.currentStreak;
        }
        
        stats.lastStudyDate = new Date().toISOString().split('T')[0];
        saveAllData();
        updatePomodoroStats();
        renderClass();
    }
}

// Giriş
loginBtn.addEventListener('click', async () => {
    const name = studentName.value.trim();
    const surname = studentSurname.value.trim();
    if (!name || !surname) {
        alert("Lütfen ad ve soyad girin!");
        return;
    }
    
    currentUser = { name, surname };
    const existingStudent = students.find(s => 
        s.name.toLowerCase() === name.toLowerCase() && 
        s.surname.toLowerCase() === surname.toLowerCase()
    );
    
    if (!existingStudent) {
        students.push({
            name, 
            surname, 
            joinDate: new Date().toLocaleString('tr-TR'), 
            joinTimestamp: new Date().getTime()
        });
        await FirebaseStorage.saveData('students', students);
    }
    
    // Kullanıcı istatistiklerini başlat
    const userKey = `${name}_${surname}`;
    if (!userStats[userKey]) {
        userStats[userKey] = {
            monthlyXP: 0,
            monthlyStudyTime: 0,
            monthlySessions: 0,
            totalXP: 0,
            totalStudyTime: 0,
            totalSessions: 0,
            level: 1,
            currentStreak: 0,
            longestStreak: 0,
            lastStudyDate: null,
            joinDate: new Date().toLocaleString('tr-TR'),
            lastActive: new Date().toLocaleString('tr-TR')
        };
        await FirebaseStorage.saveData('userStats', userStats);
    }
    
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    loginModal.style.display = 'none';
    updateUI();
    renderClass();
    updatePomodoroStats();
    renderLeaderboards();
});

function updateUI() {
    if (currentUser) {
        userInfo.style.display = 'block';
        userName.textContent = isAdmin ? "Admin" : `${currentUser.name} ${currentUser.surname}`;
        welcomeMessage.textContent = isAdmin ? `Hoş geldiniz Admin!` : `Hoş geldiniz ${currentUser.name} ${currentUser.surname}! Portalınıza hoş geldiniz.`;
    }
}

// Menü
menuBtn.addEventListener('click', () => {
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
});

overlay.addEventListener('click', () => {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
});

sidebarLinks.forEach(link => {
    link.addEventListener('click', e => {
        e.preventDefault();
        const sectionId = link.getAttribute('data-section');
        sections.forEach(sec => sec.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        
        if (sectionId === 'examTopics') {
            if (isAdmin) addExamTopicBtn.style.display = 'inline-block';
            else addExamTopicBtn.style.display = 'none';
        }
        
        if (sectionId === 'leaderboard') {
            renderLeaderboards();
        }
    });
});

// Admin girişi
adminSwitch.addEventListener('click', () => {
    const pass = prompt("Admin şifresini girin:");
    if (pass === "Gityazarkandayım") {
        isAdmin = true;
        updateUI();
        renderClass();
    } else {
        alert("Şifre yanlış!");
    }
});

// İçerik tipi değiştiğinde önem seviyesi ayarı
contentTypeSelect.addEventListener('change', function() {
    const type = this.value;
    const importanceSelect = document.getElementById('contentImportance');
    
    if (type === 'exam') {
        importanceSelect.innerHTML = `
            <option value="1">⭐ Düşük Önem</option>
            <option value="2">⭐⭐ Orta Önem</option>
            <option value="3" selected>⭐⭐⭐ Yüksek Önem</option>
            <option value="4">⭐⭐⭐⭐ Çok Yüksek</option>
            <option value="5">⭐⭐⭐⭐⭐ KRİTİK</option>
        `;
    } else {
        importanceSelect.innerHTML = `
            <option value="1">⭐ Düşük Önem</option>
            <option value="2">⭐⭐ Orta Önem</option>
            <option value="3">⭐⭐⭐ Yüksek Önem</option>
            <option value="0" selected>Bu alan için kullanılmıyor</option>
        `;
    }
});

// EKLE
addBtn.addEventListener('click', () => {
    if (!currentUser) {
        alert('Lütfen önce giriş yapın!');
        loginModal.style.display = 'flex';
        return;
    }
    if (!isAdmin) {
        alert('Sadece admin içerik ekleyebilir!');
        return;
    }
    addModal.style.display = 'flex';
});

closeAddModal.addEventListener('click', () => {
    addModal.style.display = 'none';
});

window.addEventListener('click', (e) => {
    if (e.target === addModal) {
        addModal.style.display = 'none';
    }
});

// İçerik kaydetme
saveContentBtn.addEventListener('click', async () => {
    const type = document.getElementById('contentType').value;
    const title = document.getElementById('contentTitle').value.trim();
    const desc = document.getElementById('contentDesc').value.trim();
    const date = document.getElementById('contentDate').value;
    const importance = parseInt(document.getElementById('contentImportance').value);
    
    if (!title) {
        alert('Başlık girin!');
        return;
    }
    
    if (type === "exam" && importance === 0) {
        alert('Sınavlar için önem seviyesi seçmelisiniz!');
        return;
    }
    
    if (type === "exam") {
        exams.push({ id: nextId++, title, desc, date, importance: importance === 0 ? 3 : importance });
        await FirebaseStorage.saveData('exams', exams);
        renderExams();
    } else if (type === "homework") {
        homeworks.push({ id: nextId++, title, desc, date, importance: importance === 0 ? null : importance });
        await FirebaseStorage.saveData('homeworks', homeworks);
        renderHomeworks();
    } else if (type === "hadis") {
        hadises.push({ id: nextId++, title, desc, date, importance: importance === 0 ? null : importance });
        await FirebaseStorage.saveData('hadises', hadises);
        renderHadis();
    }
    
    document.getElementById('contentTitle').value = '';
    document.getElementById('contentDesc').value = '';
    document.getElementById('contentDate').value = '';
    addModal.style.display = 'none';
    renderUpcoming();
});

// YENİ FONKSİYONLAR
function escapeHtml(text) {
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

// SINAV SIRALAMA FONKSİYONU
function sortExams(examsToSort, sortType) {
    const sorted = [...examsToSort];
    
    switch(sortType) {
        case "importance-date":
            return sorted.sort((a, b) => {
                const importanceDiff = (b.importance || 3) - (a.importance || 3);
                if (importanceDiff !== 0) return importanceDiff;
                
                const dateA = a.date ? new Date(a.date) : new Date(0);
                const dateB = b.date ? new Date(b.date) : new Date(0);
                return dateA - dateB;
            });
            
        case "date":
            return sorted.sort((a, b) => {
                const dateA = a.date ? new Date(a.date) : new Date(0);
                const dateB = b.date ? new Date(b.date) : new Date(0);
                return dateA - dateB;
            });
            
        case "importance":
            return sorted.sort((a, b) => {
                return (b.importance || 3) - (a.importance || 3);
            });
            
        default:
            return sorted;
    }
}

// Render fonksiyonları
function renderAll() {
    renderExams();
    renderHomeworks();
    renderHadis();
    renderClass();
    renderUpcoming();
    renderExamTopics();
    updatePomodoroStats();
}

async function renderExams() {
    const list = document.getElementById('examList');
    if (!list) return;
    
    if (exams.length === 0) {
        list.innerHTML = '<div class="card"><p>Henüz sınav eklenmedi.</p></div>';
        return;
    }
    
    const sortedExams = sortExams(exams, examSortType);
    
    list.innerHTML = sortedExams.map(exam => {
        const imp = importanceLevels[exam.importance || 3];
        const urgent = isItemUrgent(exam.date);
        return `<div class="card ${urgent ? 'urgent-card' : ''}">
            ${isAdmin ? `<button class="delete-btn" onclick="deleteItem('exam', ${exam.id})"><i class="fas fa-times"></i></button>` : ''}
            <h3>${escapeHtml(exam.title)} <span class="importance-badge ${imp.class}">${imp.icon} ${imp.label}</span>${urgent ? '<span style="color:var(--accent-danger);margin-left:8px;">🚨 SON GÜN!</span>' : ''}</h3>
            <p>${escapeHtml(exam.desc)}</p>
            <p><strong>Tarih:</strong> ${exam.date ? new Date(exam.date).toLocaleString('tr-TR') : '-'}</p>
        </div>`;
    }).join('');
}

async function renderHomeworks() {
    const list = document.getElementById('homeworkList');
    if (!list) return;
    
    if (homeworks.length === 0) {
        list.innerHTML = '<div class="card"><p>Henüz ödev eklenmedi.</p></div>';
        return;
    }
    
    const sortedHomeworks = [...homeworks].sort((a, b) => {
        const dateA = a.date ? new Date(a.date) : new Date(0);
        const dateB = b.date ? new Date(b.date) : new Date(0);
        return dateA - dateB;
    });
    
    list.innerHTML = sortedHomeworks.map(hw => {
        const imp = hw.importance ? importanceLevels[hw.importance] : null;
        const urgent = isItemUrgent(hw.date);
        return `<div class="card ${urgent ? 'urgent-card' : ''}">
            ${isAdmin ? `<button class="delete-btn" onclick="deleteItem('homework', ${hw.id})"><i class="fas fa-times"></i></button>` : ''}
            <h3>${escapeHtml(hw.title)} ${imp ? `<span class="importance-badge ${imp.class}">${imp.icon} ${imp.label}</span>` : ''}${urgent ? '<span style="color:var(--accent-danger);margin-left:8px;">🚨 SON GÜN!</span>' : ''}</h3>
            <p>${escapeHtml(hw.desc)}</p>
            <p><strong>Teslim Tarihi:</strong> ${hw.date ? new Date(hw.date).toLocaleString('tr-TR') : '-'}</p>
        </div>`;
    }).join('');
}

async function renderHadis() {
    const list = document.getElementById('hadisList');
    if (!list) return;
    if (hadises.length === 0) {
        list.innerHTML = '<div class="card"><p>Henüz hadis eklenmedi.</p></div>';
        return;
    }
    list.innerHTML = hadises.map(hd => {
        const imp = hd.importance ? importanceLevels[hd.importance] : null;
        return `<div class="card">
            ${isAdmin ? `<button class="delete-btn" onclick="deleteItem('hadis', ${hd.id})"><i class="fas fa-times"></i></button>` : ''}
            <h3>${escapeHtml(hd.title)} ${imp ? `<span class="importance-badge ${imp.class}">${imp.icon} ${imp.label}</span>` : ''}</h3>
            <p>${escapeHtml(hd.desc)}</p>
        </div>`;
    }).join('');
}

function renderClass() {
    const list = document.getElementById('classList');
    if (!list) return;
    if (students.length === 0) {
        list.innerHTML = '<p>Sınıf listesi henüz oluşturulmadı.</p>';
        return;
    }
    
    const sorted = [...students].sort((a, b) => (b.joinTimestamp || 0) - (a.joinTimestamp || 0));
    list.innerHTML = sorted.map((s, i) => {
        const userKey = `${s.name}_${s.surname}`;
        const stats = userStats[userKey] || { 
            level: 1, 
            totalXP: 0, 
            totalStudyTime: 0, 
            monthlyXP: 0,
            currentStreak: 0,
            longestStreak: 0
        };
        
        const level = stats.level || 1;
        const totalXP = stats.totalXP || 0;
        const streak = stats.currentStreak || 0;
        const longestStreak = stats.longestStreak || 0;
        const streakColor = getStreakColor(streak);
        
        return `
            <div class="student-item">
                <strong>${i + 1}. ${escapeHtml(s.name)} ${escapeHtml(s.surname)} 
                    <span class="student-level">Seviye ${level}</span>
                </strong>
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 6px;">
                    <div style="background: ${streakColor}; 
                                padding: 4px 10px; 
                                border-radius: 12px; 
                                font-size: 0.8rem;
                                font-weight: bold;
                                color: white;
                                display: flex;
                                align-items: center;
                                gap: 4px;">
                        🔥 ${streak}
                    </div>
                    <small style="color:#94a3b8;">
                        ${Math.floor(totalXP)} XP • ${longestStreak} En Uzun
                    </small>
                </div>
            </div>
        `;
    }).join('');
}

function renderUpcoming() {
    const list = document.getElementById('upcomingList');
    if (!list) return;
    const now = new Date();
    let upcoming = [];
    exams.forEach(e => {
        if (e.date) {
            const diff = (new Date(e.date) - now) / (1000 * 60 * 60 * 24);
            if (diff >= 0 && diff <= 2) upcoming.push({ type: "Sınav", title: e.title, date: e.date, importance: e.importance });
        }
    });
    homeworks.forEach(h => {
        if (h.date) {
            const diff = (new Date(h.date) - now) / (1000 * 60 * 60 * 24);
            if (diff >= 0 && diff <= 2) upcoming.push({ type: "Ödev", title: h.title, date: h.date, importance: h.importance });
        }
    });
    if (upcoming.length === 0) {
        list.innerHTML = '<li>Yaklaşan sınav veya ödev bulunmamaktadır.</li>';
        return;
    }
    list.innerHTML = upcoming.map(item => {
        const imp = item.importance ? importanceLevels[item.importance] : null;
        return `<li><strong>${item.type}:</strong> ${escapeHtml(item.title)} ${imp ? `<span class="importance-badge ${imp.class}">${imp.icon}</span>` : ''} <small>(${new Date(item.date).toLocaleString('tr-TR')})</small></li>`;
    }).join('');
}

function isItemUrgent(date) {
    if (!date) return false;
    const now = new Date();
    const diff = (new Date(date) - now) / (1000 * 60 * 60 * 24);
    return diff >= 0 && diff <= 1;
}

async function deleteItem(type, id) {
    if (type === "exam") {
        exams = exams.filter(e => e.id !== id);
        await FirebaseStorage.saveData('exams', exams);
        renderExams();
    } else if (type === "homework") {
        homeworks = homeworks.filter(h => h.id !== id);
        await FirebaseStorage.saveData('homeworks', homeworks);
        renderHomeworks();
    } else if (type === "hadis") {
        hadises = hadises.filter(h => h.id !== id);
        await FirebaseStorage.saveData('hadises', hadises);
        renderHadis();
    }
    renderUpcoming();
}

// Sınav sıralama event listener'ları
if (examSorting) {
    examSorting.addEventListener('click', (e) => {
        if (e.target.classList.contains('sort-option')) {
            document.querySelectorAll('.sort-option').forEach(opt => {
                opt.classList.remove('active');
            });
            e.target.classList.add('active');
            examSortType = e.target.dataset.sort;
            renderExams();
        }
    });
}

// ---------------- Sayaç Fonksiyonu ----------------
function startCountdown() {
    const targetDate = new Date("2025-11-07T15:40:00");
    const daysEl = document.getElementById('days');
    const hoursEl = document.getElementById('hours');
    const minutesEl = document.getElementById('minutes');
    const secondsEl = document.getElementById('seconds');

    function updateCountdown() {
        const now = new Date();
        const diff = targetDate - now;

        if (diff <= 0) {
            daysEl.textContent = "00";
            hoursEl.textContent = "00";
            minutesEl.textContent = "00";
            secondsEl.textContent = "00";
            clearInterval(interval);
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((diff / (1000 * 60)) % 60);
        const seconds = Math.floor((diff / 1000) % 60);

        daysEl.textContent = days.toString().padStart(2, "0");
        hoursEl.textContent = hours.toString().padStart(2, "0");
        minutesEl.textContent = minutes.toString().padStart(2, "0");
        secondsEl.textContent = seconds.toString().padStart(2, "0");
    }

    updateCountdown();
    const interval = setInterval(updateCountdown, 1000);
}

// Sınav Konuları Fonksiyonları
closeTopicModal.addEventListener('click', () => {
    addTopicModal.style.display = 'none';
    resetTopicInputs();
});

window.addEventListener('click', (e) => {
    if (e.target === addTopicModal) {
        addTopicModal.style.display = 'none';
        resetTopicInputs();
    }
});

function resetTopicInputs() {
    topicsInputs.innerHTML = `
        <div class="topic-input-group">
            <input type="text" class="topic-input" placeholder="Konu başlığı">
            <button type="button" class="remove-topic-btn" onclick="removeTopicInput(this)" style="display:none;">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
}

addTopicInputBtn.addEventListener('click', () => {
    const currentInputs = topicsInputs.querySelectorAll('.topic-input-group');
    if (currentInputs.length >= 10) {
        alert('Maksimum 10 konu ekleyebilirsiniz!');
        return;
    }
    
    const newInputGroup = document.createElement('div');
    newInputGroup.className = 'topic-input-group';
    newInputGroup.innerHTML = `
        <input type="text" class="topic-input" placeholder="Konu başlığı">
        <button type="button" class="remove-topic-btn" onclick="removeTopicInput(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    topicsInputs.appendChild(newInputGroup);
});

function removeTopicInput(button) {
    const inputGroups = topicsInputs.querySelectorAll('.topic-input-group');
    if (inputGroups.length > 1) {
        button.parentElement.remove();
    }
}

saveTopicBtn.addEventListener('click', async () => {
    const examId = topicExamSelect.value;
    const topicInputs = topicsInputs.querySelectorAll('.topic-input');
    
    if (!examId) {
        alert('Lütfen sınav seçin!');
        return;
    }
    
    const topics = [];
    topicInputs.forEach(input => {
        const title = input.value.trim();
        if (title) {
            topics.push(title);
        }
    });
    
    if (topics.length === 0) {
        alert('Lütfen en az bir konu girin!');
        return;
    }
    
    const exam = exams.find(e => e.id == examId);
    if (exam) {
        topics.forEach(topic => {
            examTopics.push({
                id: nextId++,
                examId: Number(examId),
                examTitle: exam.title,
                title: topic,
                desc: ""
            });
        });
        
        await FirebaseStorage.saveData('examTopics', examTopics);
        resetTopicInputs();
        topicExamSelect.value = '';
        addTopicModal.style.display = 'none';
        renderExamTopics();
        alert('Konular başarıyla eklendi!');
    }
});

function renderExamTopics() {
    if (exams.length === 0) {
        examTopicsList.innerHTML = '<div class="card"><p>Henüz sınav eklenmedi.</p></div>';
        return;
    }
    
    if (examTopics.length === 0) {
        examTopicsList.innerHTML = '<div class="card"><p>Henüz sınav konusu eklenmedi.</p></div>';
        return;
    }

    let html = '';
    
    const examsWithTopics = {};
    examTopics.forEach(topic => {
        if (!examsWithTopics[topic.examId]) {
            examsWithTopics[topic.examId] = {
                exam: exams.find(e => e.id === topic.examId),
                topics: []
            };
        }
        examsWithTopics[topic.examId].topics.push(topic);
    });

    Object.values(examsWithTopics)
        .sort((a, b) => new Date(a.exam.date) - new Date(b.exam.date))
        .forEach(({ exam, topics }) => {
            html += `
                <div class="exam-card">
                    <div class="exam-header" onclick="toggleTopics(this)">
                        <h3>${escapeHtml(exam.title)}</h3>
                        <div class="toggle-icon">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="exam-topics">
                        ${topics.map(topic => `
                            <div class="topic-item">
                                <strong>${escapeHtml(topic.title)}</strong>
                                ${topic.desc ? `<p>${escapeHtml(topic.desc)}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
    
    examTopicsList.innerHTML = html;
}

function toggleTopics(header) {
    const topics = header.nextElementSibling;
    const isActive = topics.classList.contains('active');
    
    document.querySelectorAll('.exam-topics').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.exam-header').forEach(h => h.classList.remove('active'));
    
    if (!isActive) {
        topics.classList.add('active');
        header.classList.add('active');
    }
}

addExamTopicBtn.addEventListener('click', () => {
    if (exams.length === 0) {
        alert("Önce sınav ekleyin!");
        return;
    }
    addTopicModal.style.display = 'flex';
    topicExamSelect.innerHTML = '<option value="">Sınav Seçin</option>' +
        exams.map(e => `<option value="${e.id}">${escapeHtml(e.title)}</option>`).join('');
});

// POMODORO SİSTEMİ
timeOptions.forEach(option => {
    option.addEventListener('click', () => {
        timeOptions.forEach(opt => opt.classList.remove('active'));
        option.classList.add('active');
        selectedTime = parseInt(option.dataset.minutes);
        currentTime = selectedTime * 60;
        updateTimerDisplay();
    });
});

function updateTimerDisplay() {
    const minutes = Math.floor(currentTime / 60);
    const seconds = currentTime % 60;
    pomodoroTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startTimer() {
    if (isRunning) return;
    
    isRunning = true;
    startPomodoro.disabled = true;
    pausePomodoro.disabled = false;
    startTime = Date.now();
    earnedXP = 0;
    
    pomodoroInterval = setInterval(() => {
        currentTime--;
        updateTimerDisplay();
        
        if (startTime) {
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            earnedXP = elapsedSeconds / 60;
        }
        
        if (currentTime <= 0) {
            completeSession();
        }
    }, 1000);
}

function pauseTimer() {
    if (!isRunning) return;
    
    isRunning = false;
    clearInterval(pomodoroInterval);
    startPomodoro.disabled = false;
    pausePomodoro.disabled = true;
}

function resetTimer() {
    if (earnedXP > 0.0167) {
        saveEarnedXP();
    }
    
    pauseTimer();
    currentTime = selectedTime * 60;
    updateTimerDisplay();
    startPomodoro.disabled = false;
    pausePomodoro.disabled = true;
    earnedXP = 0;
}

function saveEarnedXP() {
    if (!currentUser) return;
    
    const userKey = `${currentUser.name}_${currentUser.surname}`;
    if (!userStats[userKey]) {
        userStats[userKey] = {
            monthlyXP: 0,
            monthlyStudyTime: 0,
            monthlySessions: 0,
            totalXP: 0,
            totalStudyTime: 0,
            totalSessions: 0,
            level: 1,
            currentStreak: 0,
            longestStreak: 0,
            lastStudyDate: null,
            joinDate: new Date().toLocaleString('tr-TR'),
            lastActive: new Date().toLocaleString('tr-TR')
        };
    }
    
    const roundedXP = Math.floor(earnedXP * 100) / 100;
    const roundedMinutes = Math.floor(earnedXP * 100) / 100;
    
    userStats[userKey].monthlyStudyTime = (userStats[userKey].monthlyStudyTime || 0) + roundedMinutes;
    userStats[userKey].monthlySessions = (userStats[userKey].monthlySessions || 0) + 1;
    userStats[userKey].monthlyXP = (userStats[userKey].monthlyXP || 0) + roundedXP;
    
    userStats[userKey].totalStudyTime = (userStats[userKey].totalStudyTime || 0) + roundedMinutes;
    userStats[userKey].totalSessions = (userStats[userKey].totalSessions || 0) + 1;
    userStats[userKey].totalXP = (userStats[userKey].totalXP || 0) + roundedXP;
    
    updateStreak();
    
    const newLevel = Math.floor((userStats[userKey].totalXP || 0) / 250) + 1;
    if (newLevel > (userStats[userKey].level || 1)) {
        userStats[userKey].level = newLevel;
    }
    
    saveAllData();
    updatePomodoroStats();
    renderClass();
    renderLeaderboards();
    
    if (roundedXP >= 0.5) {
        alert(`⏱️ ${roundedMinutes.toFixed(1)} dakika kaydedildi!\n+${roundedXP.toFixed(1)} XP kazandın!`);
    }
}

function completeSession() {
    pauseTimer();
    
    if (!currentUser) return;
    
    const userKey = `${currentUser.name}_${currentUser.surname}`;
    if (!userStats[userKey]) {
        userStats[userKey] = {
            monthlyXP: 0,
            monthlyStudyTime: 0,
            monthlySessions: 0,
            totalXP: 0,
            totalStudyTime: 0,
            totalSessions: 0,
            level: 1,
            currentStreak: 0,
            longestStreak: 0,
            lastStudyDate: null,
            joinDate: new Date().toLocaleString('tr-TR'),
            lastActive: new Date().toLocaleString('tr-TR')
        };
    }
    
    userStats[userKey].monthlyStudyTime = (userStats[userKey].monthlyStudyTime || 0) + selectedTime;
    userStats[userKey].monthlySessions = (userStats[userKey].monthlySessions || 0) + 1;
    userStats[userKey].monthlyXP = (userStats[userKey].monthlyXP || 0) + selectedTime;
    
    userStats[userKey].totalStudyTime = (userStats[userKey].totalStudyTime || 0) + selectedTime;
    userStats[userKey].totalSessions = (userStats[userKey].totalSessions || 0) + 1;
    userStats[userKey].totalXP = (userStats[userKey].totalXP || 0) + selectedTime;
    
    updateStreak();
    
    const newLevel = Math.floor((userStats[userKey].totalXP || 0) / 250) + 1;
    if (newLevel > (userStats[userKey].level || 1)) {
        userStats[userKey].level = newLevel;
        alert(`🎉 Tebrikler! Seviye ${newLevel} oldunuz! 🎉`);
    }
    
    saveAllData();
    updatePomodoroStats();
    renderClass();
    renderLeaderboards();
    
  alert('🎯 Oturum tamamlandı! 🎯\n' + 
          `+${selectedTime} XP kazandınız!\n` +
          `Toplam: ${userStats[userKey].totalXP || 0} XP`);
    
    resetTimer();
}

function updatePomodoroStats() {
    if (!currentUser) return;
    
    const userKey = `${currentUser.name}_${currentUser.surname}`;
    const stats = userStats[userKey];
    
    if (stats) {
        const totalXP = stats.totalXP || 0;
        const totalStudyTime = stats.totalStudyTime || 0;
        const monthlyXP = stats.monthlyXP || 0;
        const level = stats.level || 1;
        const currentStreak = stats.currentStreak || 0;
        
        totalStudyTimeEl.textContent = Math.floor(totalStudyTime);
        currentLevel.textContent = level;
        currentXP.textContent = Math.floor(totalXP);
        currentStreakEl.textContent = currentStreak;
        
        const currentLevelXP = (totalXP % 250) || 0;
        const xpPercentage = Math.min(100, Math.max(0, (currentLevelXP / 250) * 100));
        xpProgress.style.width = `${xpPercentage}%`;
        nextLevelXP.textContent = Math.max(0, 250 - currentLevelXP);
    } else {
        totalStudyTimeEl.textContent = "0";
        currentLevel.textContent = "1";
        currentXP.textContent = "0";
        currentStreakEl.textContent = "0";
        xpProgress.style.width = "0%";
        nextLevelXP.textContent = "250";
    }
}

// LİDERLİK TABLOLARI
function renderLeaderboards() {
    renderMonthlyLeaderboard();
    renderTotalLeaderboard();
}

function renderMonthlyLeaderboard() {
    if (!monthlyLeaderboard) return;
    
    const sortedUsers = Object.entries(userStats)
        .map(([userKey, stats]) => {
            const [name, surname] = userKey.split('_');
            return {
                name,
                surname,
                monthlyXP: stats.monthlyXP || 0,
                monthlyStudyTime: stats.monthlyStudyTime || 0,
                level: stats.level || 1,
                currentStreak: stats.currentStreak || 0
            };
        })
        .sort((a, b) => b.monthlyXP - a.monthlyXP)
        .filter(user => user.monthlyXP > 0);
    
    if (sortedUsers.length === 0) {
        monthlyLeaderboard.innerHTML = '<p>Henüz aylık liderlik verisi yok.</p>';
        return;
    }
    
    monthlyLeaderboard.innerHTML = sortedUsers.map((user, index) => {
        const rank = index + 1;
        let medal = '';
        if (rank === 1) medal = '🥇';
        else if (rank === 2) medal = '🥈';
        else if (rank === 3) medal = '🥉';
        
        const streakColor = getStreakColor(user.currentStreak);
        
        return `
            <div class="leaderboard-item">
                <div class="leaderboard-rank">${rank}</div>
                <div class="leaderboard-info">
                    <div class="leaderboard-name">${escapeHtml(user.name)} ${escapeHtml(user.surname)} 
                        <span style="background: ${streakColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white;">🔥 ${user.currentStreak}</span>
                    </div>
                    <div class="leaderboard-level">${Math.floor(user.monthlyXP)} XP • ${Math.floor(user.monthlyStudyTime)} dakika</div>
                </div>
                <div class="leaderboard-xp">${medal}</div>
            </div>
        `;
    }).join('');
}

function renderTotalLeaderboard() {
    if (!totalLeaderboard) return;
    
    const sortedUsers = Object.entries(userStats)
        .map(([userKey, stats]) => {
            const [name, surname] = userKey.split('_');
            return {
                name,
                surname,
                totalXP: stats.totalXP || 0,
                totalStudyTime: stats.totalStudyTime || 0,
                level: stats.level || 1,
                currentStreak: stats.currentStreak || 0
            };
        })
        .sort((a, b) => b.totalXP - a.totalXP)
        .filter(user => user.totalXP > 0);
    
    if (sortedUsers.length === 0) {
        totalLeaderboard.innerHTML = '<p>Henüz toplam liderlik verisi yok.</p>';
        return;
    }
    
    totalLeaderboard.innerHTML = sortedUsers.map((user, index) => {
        const rank = index + 1;
        let medal = '';
        if (rank === 1) medal = '⭐';
        else if (rank === 2) medal = '🌟';
        else if (rank === 3) medal = '✨';
        
        const streakColor = getStreakColor(user.currentStreak);
        
        return `
            <div class="leaderboard-item">
                <div class="leaderboard-rank">${rank}</div>
                <div class="leaderboard-info">
                    <div class="leaderboard-name">${escapeHtml(user.name)} ${escapeHtml(user.surname)} 
                        <span class="total-badge">Seviye ${user.level}</span>
                        <span style="background: ${streakColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white;">🔥 ${user.currentStreak}</span>
                    </div>
                    <div class="leaderboard-level">${Math.floor(user.totalXP)} XP • ${Math.floor(user.totalStudyTime)} dakika</div>
                </div>
                <div class="leaderboard-xp">${medal}</div>
            </div>
        `;
    }).join('');
}

// Event Listeners
startPomodoro.addEventListener('click', startTimer);
pausePomodoro.addEventListener('click', pauseTimer);
resetPomodoro.addEventListener('click', resetTimer);

// İlk yükleme
updateTimerDisplay();

// Sayfa her açıldığında aylık sıfırlama kontrolü
setInterval(checkMonthlyReset, 60 * 60 * 1000);

// 🔥 DOMAIN GÜVENLİK KONTROLÜ
function checkDomainSecurity() {
    const allowedDomains = [
        'https://batuhan785.github.io',
        'https://batuhan785.github.io/Site/',
        'http://localhost' // Local geliştirme için
    ];
    
    const currentDomain = window.location.origin;
    const isAllowed = allowedDomains.some(domain => currentDomain.includes(domain));
    
    if (!isAllowed) {
        console.error('🚨 Güvenlik Uyarısı: Yetkisiz domain!');
        alert('Bu domain için yetkiniz bulunmamaktadır!');
        return false;
    }
    return true;
}

// Uygulama başlatma
window.addEventListener('load', async () => {
    if (!checkDomainSecurity()) {
        return;
    }
    
    await loadAllData();
    startRealTimeSync();
    startCountdown();
    renderLeaderboards();
    checkMonthlyReset();
});

// Global fonksiyonlar - HTML'de onclick için gerekli
window.deleteItem = deleteItem;
window.removeTopicInput = removeTopicInput;
window.toggleTopics = toggleTopics;

});
  </script>
</body>
</html>
