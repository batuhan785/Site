<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Öğrenci Portalı</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins','Segoe UI',sans-serif;}
:root {
  --primary-dark: #1e3a8a;
  --accent-warning: #f59e0b;
  --accent-danger: #dc2626;
  --accent-success: #059669;
  --bg-dark: #0f172a;
  --bg-card: #1e293b;
  --text-light: #f8fafc;
  --border-color: #334155;
}
body{background:linear-gradient(135deg, var(--bg-dark), #1e3a8a, #0f766e);color:var(--text-light);min-height:100vh;overflow-x:hidden;}
.login-modal{display:flex;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);align-items:center;justify-content:center;}
.login-content{background:var(--bg-card);padding:30px;border-radius:15px;width:90%;max-width:400px;border:2px solid var(--accent-warning);text-align:center;}
.login-content h2{margin-bottom:20px;color:var(--accent-warning);}
.login-content input{padding:12px;margin:10px 0;width:100%;border-radius:8px;border:1px solid var(--accent-warning);background:rgba(255,255,255,0.1);color:white;}
.login-btn{background:linear-gradient(135deg,var(--accent-warning),var(--accent-danger));color:white;border:none;padding:12px;width:100%;border-radius:8px;cursor:pointer;margin-top:10px;font-size:16px;}
header{background:rgba(15, 23, 42, 0.9);padding:14px 18px;display:flex;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.5);position:sticky;top:0;z-index:100;backdrop-filter:blur(8px);border-bottom:1px solid var(--border-color);}
.menu-btn{font-size:24px;cursor:pointer;margin-right:12px;color:var(--accent-warning);}
.header-title{flex:1;text-align:center;font-size:1.45rem;font-weight:600;}
.user-info{margin-left:auto;font-size:0.9rem;color:var(--accent-warning);text-align:right;cursor:pointer;}
.user-info small{display:block;font-size:0.7rem;color:#ccc;}
.sidebar{width:260px;background:var(--bg-card);position:fixed;top:0;left:-260px;height:100%;padding-top:70px;transition:left .3s ease;z-index:200;overflow-y:auto;backdrop-filter:blur(10px);border-right:1px solid var(--border-color);}
.sidebar.active{left:0;}
.sidebar a{display:block;color:var(--text-light);padding:15px 20px;text-decoration:none;border-bottom:1px solid var(--border-color);}
.sidebar a:hover{background:rgba(245,158,11,0.15);}
.overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:150;}
.overlay.active{display:block;}
.container{padding:22px;max-width:1100px;margin:0 auto;}
.countdown-container{width:100%;background:var(--bg-card);border-radius:18px;padding:26px;margin-bottom:26px;box-shadow:0 10px 30px rgba(0,0,0,0.28);border:1px solid var(--border-color);text-align:center;}
.countdown-title{font-size:1.75rem;margin-bottom:18px;font-weight:700;color:var(--accent-warning);}
.countdown-row{display:flex;gap:14px;justify-content:center;margin-bottom:10px;}
.countdown-item{background:rgba(255,255,255,0.08);padding:18px 12px;border-radius:14px;display:flex;flex-direction:column;align-items:center;min-width:64px;border:1px solid var(--border-color);}
.countdown-item span.value{font-size:2.1rem;font-weight:800;color:var(--accent-warning);}
.countdown-item label{margin-top:6px;font-size:0.95rem;color:rgba(255,255,255,0.92);}
.holiday-info{font-size:1.05rem;margin-top:16px;color:var(--accent-warning);font-weight:600;}
.content{display:none;animation:fadeIn .4s ease;}
.content.active{display:block;}
.card{background:var(--bg-card);padding:22px;margin:18px 0;border-radius:14px;border:1px solid var(--border-color);position:relative;}
.card h3{margin-bottom:12px;font-size:1.35rem;border-left:6px solid var(--accent-warning);padding-left:12px;}
.delete-btn{position:absolute;top:12px;right:12px;background:var(--accent-danger);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;color:white;}
.add-btn{position:fixed;bottom:28px;right:22px;width:68px;height:68px;border-radius:50%;background:linear-gradient(135deg,var(--accent-warning),var(--accent-danger));display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;z-index:120;box-shadow:0 4px 20px rgba(245, 158, 11, 0.3);border:none;color:white;}
input,select,textarea{padding:14px;width:100%;border-radius:10px;margin-bottom:14px;background:var(--bg-card);color:white;border:1px solid var(--border-color);}
button{background:linear-gradient(135deg,var(--accent-warning),var(--accent-danger));color:white;border:none;padding:12px;width:100%;border-radius:10px;font-size:15px;cursor:pointer;}
.modal{display:none;position:fixed;z-index:300;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);align-items:center;justify-content:center;}
.modal-content{background-color:var(--bg-card);padding:25px;border-radius:12px;width:90%;max-width:500px;border:1px solid var(--border-color);backdrop-filter:blur(10px);}
.close{color:var(--accent-warning);float:right;font-size:28px;font-weight:bold;cursor:pointer;}
#upcomingList li{margin:10px 0;padding:12px;background:rgba(255,255,255,0.06);border-radius:8px;list-style:none;}

/* Tatil değiştirici için yeni stiller */
.change-countdown-btn {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  margin-left: 10px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.holiday-selector-modal .modal-content {
  max-width: 400px;
}

.holiday-option {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid var(--border-color);
  padding: 15px;
  margin: 10px 0;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.holiday-option:hover {
  background: rgba(245, 158, 11, 0.2);
  border-color: var(--accent-warning);
}

.holiday-option.active {
  background: linear-gradient(135deg, var(--accent-warning), var(--accent-danger));
  border-color: var(--accent-warning);
}

.holiday-dates {
  font-size: 0.9rem;
  color: #94a3b8;
  margin-top: 5px;
}

/* SYNC BUTONU STİLLERİ */
.sync-button {
  background: linear-gradient(135deg, var(--accent-warning), var(--accent-danger));
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  cursor: pointer;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
  transition: all 0.3s ease;
  margin-left: 15px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.sync-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.sync-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* VERİ GÖNDERİM BUTONU */
.data-send-btn {
  background: linear-gradient(135deg, #10b981, #059669);
  border: none;
  color: white;
  padding: 10px 20px;
  border-radius: 20px;
  font-size: 14px;
  cursor: pointer;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  transition: all 0.3s ease;
  margin: 5px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.data-send-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.data-send-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.status-message {
  padding: 10px 15px;
  border-radius: 8px;
  margin: 10px 0;
  font-size: 14px;
}

.status-success {
  background: rgba(16, 185, 129, 0.2);
  border-left: 4px solid #10b981;
  color: #10b981;
}

.status-error {
  background: rgba(239, 68, 68, 0.2);
  border-left: 4px solid #ef4444;
  color: #ef4444;
}

.status-sending {
  background: rgba(245, 158, 11, 0.2);
  border-left: 4px solid #f59e0b;
  color: #f59e0b;
}

/* ÖNEM PUANI STİLLERİ */
.importance-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;font-size:0.8rem;margin-left:8px;}
.importance-1{background:#6b7280; color:white;}
.importance-2{background:#3b82f6; color:white;}
.importance-3{background:#f59e0b; color:black;}
.importance-4{background:#ef4444; color:white;}
.importance-5{background:#dc2626; color:white;}
.urgent-card{border-left:6px solid var(--accent-danger) !important;background:linear-gradient(135deg, var(--bg-card), rgba(220, 38, 38, 0.1)) !important;}

/* SIRALAMA SİSTEMİ */
.sorting-controls {display:flex;gap:10px;margin-bottom:20px;align-items:center;flex-wrap:wrap;}
.sort-option {background:rgba(255,255,255,0.1);border:1px solid var(--border-color);padding:8px 16px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;font-size:0.9rem;}
.sort-option.active {background:linear-gradient(135deg,var(--accent-warning),var(--accent-danger));border-color:var(--accent-warning);}
.sort-option:hover {background:rgba(245,158,11,0.2);}

/* Sınav Konuları Özel Stilleri - GÜNCELLENDİ */
.exam-card {background:var(--bg-card);border-radius:12px;margin-bottom:15px;border:1px solid var(--border-color);overflow:hidden;cursor:pointer;}
.exam-header {background:linear-gradient(135deg,var(--accent-warning),var(--accent-danger));padding:15px 20px;display:flex;justify-content:space-between;align-items:center;}
.exam-header h3 {margin:0;font-size:1.2rem;}
.exam-header .toggle-icon {transition:transform 0.3s ease;}
.exam-header.active .toggle-icon {transform:rotate(180deg);}
.exam-topics {padding:0;max-height:0;overflow:hidden;transition:max-height 0.3s ease,padding 0.3s ease;}
.exam-topics.active {padding:15px 20px;max-height:1000px;}
.topic-item {padding:10px;margin:8px 0;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid var(--accent-success);}
.topic-item:last-child {margin-bottom:0;}
.topics-input-container {margin-bottom:15px;}
.topic-input-group {display:flex;gap:10px;margin-bottom:10px;align-items:center;}
.topic-input {flex:1;}
.add-topic-input-btn {background:#3b82f6;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;width:auto;font-size:12px;}
.remove-topic-btn {background:var(--accent-danger);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;width:auto;font-size:12px;}

/* POMODORO STİLLERİ */
.pomodoro-container {
  background: var(--bg-card);
  border-radius: 18px;
  padding: 26px;
  margin-bottom: 26px;
  border: 1px solid var(--border-color);
  text-align: center;
}

.pomodoro-timer {
  font-size: 4rem;
  font-weight: 800;
  color: var(--accent-warning);
  margin: 20px 0;
  font-family: 'Courier New', monospace;
}

.pomodoro-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.pomodoro-btn {
  background: linear-gradient(135deg, var(--accent-warning), var(--accent-danger));
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.pomodoro-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.pomodoro-btn:disabled {
  background: #6b7280;
  cursor: not-allowed;
  transform: none;
}

.time-options {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}

.time-option {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid var(--border-color);
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.time-option.active {
  background: linear-gradient(135deg, var(--accent-warning), var(--accent-danger));
  border-color: var(--accent-warning);
}

.pomodoro-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.05);
  padding: 15px;
  border-radius: 10px;
  border: 1px solid var(--border-color);
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent-warning);
  display: block;
}

.stat-label {
  font-size: 0.8rem;
  color: #94a3b8;
  display: block;
  margin-top: 5px;
}

/* SEVİYE SİSTEMİ */
.level-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  margin-left: 8px;
}

.xp-bar {
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  margin: 8px 0;
  overflow: hidden;
}

.xp-progress {
  height: 100%;
  background: linear-gradient(90deg, #10b981, #34d399);
  border-radius: 4px;
  transition: width 0.5s ease;
}

.leaderboard-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  margin: 8px 0;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border-left: 4px solid var(--accent-warning);
}

.leaderboard-rank {
  font-weight: 700;
  font-size: 1.2rem;
  color: var(--accent-warning);
  min-width: 30px;
  text-align: center;
}

.leaderboard-info {
  flex: 1;
}

.leaderboard-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.leaderboard-level {
  font-size: 0.8rem;
  color: #94a3b8;
}

.leaderboard-xp {
  font-weight: 700;
  color: var(--accent-warning);
}

/* Öğrenci kartlarında seviye gösterimi */
.student-level {
  display: inline-block;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  margin-left: 8px;
}

.student-item {
  padding: 12px;
  margin: 8px 0;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  border-left: 4px solid var(--accent-warning);
}

/* İkili liderlik stilleri */
.leaderboard-section {
  margin-bottom: 30px;
}

.leaderboard-section h3 {
  color: var(--accent-warning);
  margin-bottom: 15px;
  border-left: 4px solid var(--accent-warning);
  padding-left: 10px;
}

.monthly-badge {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  margin-left: 8px;
}

.total-badge {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  margin-left: 8px;
}

/* STREAK STİLLERİ */
.streak-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: bold;
  color: white;
  margin-left: 8px;
}

@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
</style>
</head>
<body>

<!-- Giriş Modalı -->
<div id="loginModal" class="login-modal">
  <div class="login-content">
    <h2>Öğrenci Girişi</h2>
    <input type="text" id="studentName" placeholder="Adınız">
    <input type="text" id="studentSurname" placeholder="Soyadınız">
    <button class="login-btn" id="loginBtn">Giriş Yap</button>
    <small>Bilgileriniz kaydedilecektir.</small>
  </div>
</div>

<!-- Tatil Seçici Modalı -->
<div id="holidaySelectorModal" class="modal holiday-selector-modal">
  <div class="modal-content">
    <span class="close" id="closeHolidayModal">&times;</span>
    <h2>Tatil Seçin</h2>
    <div id="holidayOptions">
      <div class="holiday-option active" data-target="2025-11-07T15:40:00">
        <strong>1. Dönem Ara Tatil</strong>
        <div class="holiday-dates">7-14 Kasım 2025</div>
      </div>
      <div class="holiday-option" data-target="2026-01-21T10:00:00">
        <strong>15 Tatil</strong>
        <div class="holiday-dates">21 Ocak - 5 Şubat 2026</div>
      </div>
      <div class="holiday-option" data-target="2026-03-13T15:40:00">
        <strong>2. Dönem Ara Tatil</strong>
        <div class="holiday-dates">13-20 Mart 2026</div>
      </div>
      <div class="holiday-option" data-target="2026-06-26T10:00:00">
        <strong>Yaz Tatili</strong>
        <div class="holiday-dates">26 Haziran - 8 Eylül 2026</div>
      </div>
    </div>
    <button id="selectHolidayBtn">Seç</button>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<header>
  <div class="menu-btn" id="menuBtn"><i class="fas fa-bars"></i></div>
  <div class="header-title">Öğrenci Portalı</div>
  <div class="user-info" id="userInfo" style="display:none;">
    Hoş geldiniz<br><small id="userName"></small>
  </div>
</header>

<div class="sidebar" id="sidebar">
  <a href="#" data-section="home"><i class="fas fa-home"></i> Ana Sayfa</a>
  <a href="#" data-section="exams"><i class="fas fa-file-alt"></i> Sınavlar</a>
  <a href="#" data-section="homeworks"><i class="fas fa-tasks"></i> Ödevler</a>
  <a href="#" data-section="hadis"><i class="fas fa-book"></i> Hadis-i Şerifler</a>
  <a href="#" data-section="class"><i class="fas fa-users"></i> Sınıf Listesi</a>
  <a href="#" data-section="pomodoro"><i class="fas fa-clock"></i> Pomodoro Timer</a>
  <a href="#" data-section="leaderboard"><i class="fas fa-trophy"></i> Liderlik Tablosu</a>
  <a href="#" data-section="data-send"><i class="fas fa-paper-plane"></i> Veri Gönderim</a>
  <a href="#" id="adminSwitch"><i class="fas fa-user-shield"></i> Admin Profiline Geçiş Yap</a>
</div>

<div class="container">
  <div id="home" class="content active">
    <div class="countdown-container">
      <div class="countdown-title" id="countdownTitle">
        1. Dönem Ara Tatiline Kalan Süre
        <button class="change-countdown-btn" id="changeCountdownBtn">
          <i class="fas fa-exchange-alt"></i> Değiştir
        </button>
      </div>
      
      <div class="countdown-row">
        <div class="countdown-item"><span id="days" class="value">00</span><label>Gün</label></div>
        <div class="countdown-item"><span id="hours" class="value">00</span><label>Saat</label></div>
        <div class="countdown-item"><span id="minutes" class="value">00</span><label>Dakika</label></div>
        <div class="countdown-item"><span id="seconds" class="value">00</span><label>Saniye</label></div>
      </div>
      <div class="holiday-info" id="holidayInfo">7-14 Kasım 2025</div>
    </div>
    <div class="card">
      <h3>Hoş Geldiniz!</h3>
      <p id="welcomeMessage">Sol üstten menüye tıklayarak diğer bölümlere erişebilirsiniz.</p>
    </div>
    
    <!-- YAKLAŞAN SINAVLAR/ÖDEVLER -->
    <div class="card" id="upcomingCard">
      <h3>Yaklaşan Sınavlar/Ödevler (2 Gün Kalanlar)</h3>
      <ul id="upcomingList"><li>Yaklaşan sınav veya ödev bulunmamaktadır.</li></ul>
    </div>
  </div>

  <!-- Diğer içerik bölümleri -->
  <div id="exams" class="content">
    <h2 class="countdown-title">Sınavlar</h2>
    <div class="sorting-controls" id="examSorting">
      <div class="sort-option active" data-sort="importance-date">Öneme Göre (Yüksek→Düşük)</div>
      <div class="sort-option" data-sort="date">Tarihe Göre (Yakın→Uzak)</div>
      <div class="sort-option" data-sort="importance">Sadece Önem Seviyesi</div>
    </div>
    <div id="examList"></div>
  </div>

  <div id="homeworks" class="content">
    <h2 class="countdown-title">Ödevler</h2>
    <div id="homeworkList"></div>
  </div>

  <div id="hadis" class="content">
    <h2 class="countdown-title">Hadis-i Şerifler</h2>
    <div id="hadisList">
      <div class="card"><p>Henüz hadis eklenmedi.</p></div>
    </div>
  </div>

  <div id="class" class="content">
    <h2 class="countdown-title">Sınıf Listesi</h2>
    <div class="card">
      <div class="class-list" id="classList"><p>Sınıf listesi yükleniyor...</p></div>
    </div>
  </div>

  <!-- POMODORO TIMER BÖLÜMÜ -->
  <div id="pomodoro" class="content">
    <div class="pomodoro-container">
      <h2 class="countdown-title">Pomodoro Timer</h2>
      
      <div class="time-options">
        <div class="time-option active" data-minutes="30">30 Dakika</div>
        <div class="time-option" data-minutes="60">60 Dakika</div>
        <div class="time-option" data-minutes="90">90 Dakika</div>
      </div>
      
      <div class="pomodoro-timer" id="pomodoroTimer">30:00</div>
      
      <div class="pomodoro-controls">
        <button class="pomodoro-btn" id="startPomodoro">Başlat</button>
        <button class="pomodoro-btn" id="pausePomodoro" disabled>Duraklat</button>
        <button class="pomodoro-btn" id="resetPomodoro">Sıfırla</button>
      </div>
      
      <div class="pomodoro-stats">
        <div class="stat-card">
          <span class="stat-value" id="totalStudyTime">0</span>
          <span class="stat-label">Toplam Çalışma (dk)</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="currentLevel">1</span>
          <span class="stat-label">Seviye</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="currentXP">0</span>
          <span class="stat-label">XP</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="currentStreak">0</span>
          <span class="stat-label">Üst Üste Gün</span>
        </div>
      </div>

      <div class="xp-bar">
        <div class="xp-progress" id="xpProgress" style="width: 0%"></div>
      </div>
      <small>Sonraki seviye: <span id="nextLevelXP">250</span> XP</small>

      <!-- VERİ GÖNDERİM BUTONU POMODORO'YA EKLENDİ -->
      <button class="data-send-btn" onclick="sendPomodoroData()" style="margin-top: 20px;">
        <i class="fas fa-paper-plane"></i> POMODORO VERİLERİNİ GÖNDER
      </button>
      <div id="pomodoroSendStatus"></div>
    </div>
  </div>

  <!-- LİDERLİK TABLOSU BÖLÜMÜ -->
  <div id="leaderboard" class="content">
    <!-- AYLIK LİDERLİK -->
    <div class="card">
      <h2 class="countdown-title">🏆 AYLIK LİDERLİK</h2>
      <p>Bu ayki çalışma performansı - Her ayın 1'inde sıfırlanır</p>
      <div id="monthlyLeaderboard">
        <div class="leaderboard-item">
          <div class="leaderboard-rank">1</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">Örnek Öğrenci <span class="monthly-badge">Bu Ay</span></div>
            <div class="leaderboard-level">0 XP • 0 dakika</div>
          </div>
          <div class="leaderboard-xp">🥇</div>
        </div>
      </div>
    </div>

    <!-- TOPLAM LİDERLİK -->
    <div class="card">
      <h2 class="countdown-title">⭐ TÜM ZAMANLAR LİDERLİĞİ</h2>
      <p>Kariyer performansı - Kalıcı istatistikler</p>
      <div id="totalLeaderboard">
        <div class="leaderboard-item">
          <div class="leaderboard-rank">1</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">Örnek Öğrenci <span class="total-badge">Seviye 1</span></div>
            <div class="leaderboard-level">0 XP • 0 dakika</div>
          </div>
          <div class="leaderboard-xp">⭐</div>
        </div>
      </div>
    </div>
  </div>

  <!-- YENİ: VERİ GÖNDERİM BÖLÜMÜ -->
  <div id="data-send" class="content">
    <div class="card">
      <h2>🚀 VERİ GÖNDERİM SİSTEMİ</h2>
      <p>LocalStorage'teki tüm verileri direkt Google Forms'a gönder:</p>
      
      <button class="data-send-btn" onclick="sendAllData()">
        <i class="fas fa-paper-plane"></i> TÜM VERİLERİ GÖNDER
      </button>
      
      <button class="data-send-btn" onclick="sendPomodoroData()" style="background:linear-gradient(135deg, #f59e0b, #d97706);">
        <i class="fas fa-clock"></i> SADECE POMODORO VERİLERİ GÖNDER
      </button>
      
      <div id="sendStatus"></div>
    </div>

    <div class="card">
      <h3>📊 Mevcut Veriler</h3>
      <div id="currentData">
        <p>Veriler yükleniyor...</p>
      </div>
    </div>
  </div>
</div>

<div class="add-btn" id="addBtn"><i class="fas fa-plus"></i></div>

<!-- Modal pencereleri -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeAddModal">&times;</span>
    <h2>Yeni İçerik Ekle</h2>
    <select id="contentType">
      <option value="exam">Sınav</option>
      <option value="homework">Ödev</option>
      <option value="hadis">Hadis-i Şerif</option>
    </select>
    <input type="text" id="contentTitle" placeholder="Başlık">
    <textarea id="contentDesc" placeholder="Açıklama"></textarea>
    <input type="datetime-local" id="contentDate">
    <div id="importanceContainer">
      <select id="contentImportance">
        <option value="1">⭐ Düşük Önem</option>
        <option value="2">⭐⭐ Orta Önem</option>
        <option value="3" selected>⭐⭐⭐ Yüksek Önem</option>
        <option value="4">⭐⭐⭐⭐ Çok Yüksek</option>
        <option value="5">⭐⭐⭐⭐⭐ KRİTİK</option>
        <option value="0">Bu alan için kullanılmıyor</option>
      </select>
    </div>
    <button id="saveContentBtn">Kaydet</button>
  </div>
</div>

<!-- Sınav Konuları Ekleme Modalı -->
<div id="addTopicModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeTopicModal">&times;</span>
    <h2>Yeni Sınav Konuları Ekle</h2>
    <select id="topicExamSelect">
      <option value="">Sınav Seçin</option>
    </select>
    
    <div class="topics-input-container">
      <div id="topicsInputs">
        <div class="topic-input-group">
          <input type="text" class="topic-input" placeholder="Konu başlığı">
          <button type="button" class="remove-topic-btn" onclick="removeTopicInput(this)" style="display:none;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <button type="button" class="add-topic-input-btn" id="addTopicInputBtn">
        <i class="fas fa-plus"></i> Konu Ekle (Maksimum: 10)
      </button>
    </div>
    
    <button id="saveTopicBtn">Kaydet</button>
  </div>
</div>

<script>
// 🔥 TÜM DEĞİŞKENLER
let exams = [];
let homeworks = [];
let hadises = [];
let examTopics = [];
let students = [];
let userStats = {};
let currentUser = null;
let isAdmin = false;
let nextId = 100;
let examSortType = "importance-date";

// Pomodoro değişkenleri
let pomodoroInterval = null;
let currentTime = 30 * 60;
let isRunning = false;
let selectedTime = 30;
let earnedXP = 0;
let startTime = null;

// Tatil seçici için değişken
let currentTargetDate = "2025-11-07T15:40:00";
let countdownInterval = null;

// Önem seviyeleri
const importanceLevels = {
  1:{label:"Düşük", icon:"⭐", class:"importance-1"},
  2:{label:"Orta", icon:"⭐⭐", class:"importance-2"},
  3:{label:"Yüksek", icon:"⭐⭐⭐", class:"importance-3"},
  4:{label:"Çok Yüksek", icon:"⭐⭐⭐⭐", class:"importance-4"},
  5:{label:"KRİTİK", icon:"⭐⭐⭐⭐⭐", class:"importance-5"},
  0:{label:"Kullanılmıyor", icon:"", class:"importance-1"}
};

// STREAK RENK SİSTEMİ
const streakColors = {
  1: "#6b7280",   // Gri - Yeni başladı
  3: "#f59e0b",   // Turuncu - Ateş başladı
  7: "#ef4444",   // Kırmızı - İyi gidiyor
  14: "#dc2626",  // Koyu kırmızı - Harika
  30: "#7c3aed",  // Mor - Efsane
  60: "#10b981",  // Yeşil - Destansı
  90: "#06b6d4"   // Camgöbeği - Efsanevi
};

// TATİL BİLGİLERİ
const holidayInfo = {
  "2025-11-07T15:40:00": { title: "1. Dönem Ara Tatiline Kalan Süre", info: "7-14 Kasım 2025" },
  "2026-01-21T10:00:00": { title: "15 Tatiline Kalan Süre", info: "21 Ocak - 5 Şubat 2026" },
  "2026-03-13T15:40:00": { title: "2. Dönem Ara Tatiline Kalan Süre", info: "13-20 Mart 2026" },
  "2026-06-26T10:00:00": { title: "Yaz Tatiline Kalan Süre", info: "26 Haziran - 8 Eylül 2026" }
};

// 🔥 VERİ GÖNDERİM SİSTEMİ
const FORM_URL = 'https://docs.google.com/spreadsheets/d/1UVpxOHs92qbRLestRIGuUfUYQ58NVJn3AJALSwiPPfY/edit?usp=drivesdk';
const FORM_FIELDS = {
  OGRENCI_ADI: 'entry.2005620554',
  XP_PUANI: 'entry.1166974658',  
  CALISMA_SURESI: 'entry.839337160',
  TARIH: 'entry.1065046570'
};

// 🔥 GOOGLE SYNC SİSTEMİ
class GoogleSheetsSync {
    constructor() {
        this.sheetData = null;
        this.lastFetch = null;
    }

    async fetchFromSheets() {
        try {
            const SHEET_ID = '1UVpxOHs92qbRLestRIGuUfUYQ58NVJn3AJALSwiPPfY';
            const CSV_URL = `https://docs.google.com/spreadsheets/d/1UVpxOHs92qbRLestRIGuUfUYQ58NVJn3AJALSwiPPfY/edit?usp=drivesdk'${SHEET_ID}/export?format=csv`;
            
            console.log('📥 Google Sheets verisi çekiliyor...');
            const response = await fetch(CSV_URL);
            const csvText = await response.text();
            
            this.sheetData = this.parseCSVData(csvText);
            this.lastFetch = new Date().toLocaleString('tr-TR');
            
            console.log('✅ Google Sheets verisi alındı:', this.sheetData);
            return this.sheetData;
        } catch (error) {
            console.error('❌ Google Sheets verisi alınamadı:', error);
            return null;
        }
    }

    parseCSVData(csvText) {
        if (!csvText) return [];
        const lines = csvText.split(/\r\n|\n/);
        if (lines.length < 2) return [];

        const separator = (csvText.indexOf('\t') !== -1) ? '\t' : ',';
        const headers = lines[0].split(separator).map(header => header.trim().toLowerCase());

        const result = [];
        
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const values = lines[i].split(separator);
            const rowData = {};
            let isEmptyRow = true;

            headers.forEach((header, index) => {
                const value = values[index] ? values[index].trim() : '';
                rowData[header] = value;
                if (value) isEmptyRow = false;
            });

            if (!isEmptyRow) {
                result.push(rowData);
            }
        }
        return result;
    }

    processSheetData(sheetData) {
        if (!sheetData || sheetData.length === 0) return;

        // SINAVLAR
        const sheetExams = sheetData.filter(row => row.type === 'exam').map(row => ({
            id: parseInt(row.id) || Date.now() + Math.random(),
            title: row.title || '',
            desc: row.desc || '',
            date: row.date || null,
            importance: parseInt(row.importance) || 3
        }));

        // ÖDEVLER
        const sheetHomeworks = sheetData.filter(row => row.type === 'homework').map(row => ({
            id: parseInt(row.id) || Date.now() + Math.random(),
            title: row.title || '',
            desc: row.desc || '',
            date: row.date || null,
            importance: parseInt(row.importance) || null
        }));

        // HADİSLER
        const sheetHadises = sheetData.filter(row => row.type === 'hadis').map(row => ({
            id: parseInt(row.id) || Date.now() + Math.random(),
            title: row.title || '',
            desc: row.desc || '',
            date: row.date || null,
            importance: parseInt(row.importance) || null
        }));

        // ÖĞRENCİLER
        const sheetStudents = sheetData.filter(row => row.type === 'student').map(row => ({
            name: row.name || '',
            surname: row.surname || '',
            joinDate: row.joindate || new Date().toLocaleString('tr-TR'),
            joinTimestamp: parseInt(row.jointimestamp) || Date.now()
        }));

        // SINAV KONULARI
        const sheetExamTopics = sheetData.filter(row => row.type === 'examtopic').map(row => ({
            id: parseInt(row.id) || Date.now() + Math.random(),
            examId: parseInt(row.examid) || 0,
            examTitle: row.examtitle || '',
            title: row.topic || '',
            desc: row.desc || ''
        }));

        // LİDERLİK VERİLERİ
        const sheetLeaders = sheetData.filter(row => row.type === 'leaderboard').map(row => ({
            name: row.name || '',
            surname: row.surname || '',
            totalXP: parseInt(row.totalxp) || 0,
            totalStudyTime: parseInt(row.totalstudytime) || 0,
            monthlyXP: parseInt(row.monthlyxp) || 0,
            monthlyStudyTime: parseInt(row.monthlystudytime) || 0,
            level: parseInt(row.level) || 1,
            currentStreak: parseInt(row.currentstreak) || 0,
            lastUpdate: row.lastupdate || new Date().toLocaleString('tr-TR')
        }));

        // VERİLERİ GÜNCELLE
        if (sheetExams.length > 0) {
            exams = sheetExams;
            localStorage.setItem('exams', JSON.stringify(exams));
        }
        
        if (sheetHomeworks.length > 0) {
            homeworks = sheetHomeworks;
            localStorage.setItem('homeworks', JSON.stringify(homeworks));
        }
        
        if (sheetHadises.length > 0) {
            hadises = sheetHadises;
            localStorage.setItem('hadises', JSON.stringify(hadises));
        }
        
        if (sheetStudents.length > 0) {
            students = sheetStudents;
            localStorage.setItem('students', JSON.stringify(students));
        }

        if (sheetExamTopics.length > 0) {
            examTopics = sheetExamTopics;
            localStorage.setItem('examTopics', JSON.stringify(examTopics));
        }

        if (sheetLeaders.length > 0) {
            sheetLeaders.forEach(leader => {
                const userKey = `${leader.name}_${leader.surname}`;
                if (!userStats[userKey]) {
                    userStats[userKey] = {
                        monthlyXP: 0,
                        monthlyStudyTime: 0,
                        monthlySessions: 0,
                        totalXP: 0,
                        totalStudyTime: 0,
                        totalSessions: 0,
                        level: 1,
                        currentStreak: 0,
                        longestStreak: 0,
                        lastStudyDate: null,
                        joinDate: new Date().toLocaleString('tr-TR'),
                        lastActive: new Date().toLocaleString('tr-TR')
                    };
                }
                
                userStats[userKey].totalXP = leader.totalXP || userStats[userKey].totalXP;
                userStats[userKey].totalStudyTime = leader.totalStudyTime || userStats[userKey].totalStudyTime;
                userStats[userKey].monthlyXP = leader.monthlyXP || userStats[userKey].monthlyXP;
                userStats[userKey].monthlyStudyTime = leader.monthlyStudyTime || userStats[userKey].monthlyStudyTime;
                userStats[userKey].level = leader.level || userStats[userKey].level;
                userStats[userKey].currentStreak = leader.currentStreak || userStats[userKey].currentStreak;
            });
            
            localStorage.setItem('userStats', JSON.stringify(userStats));
        }

        this.updateUI();
    }

    updateUI() {
        renderExams();
        renderHomeworks();
        renderHadis();
        renderClass();
        renderUpcoming();
        renderLeaderboards();
        updatePomodoroStats();
    }

    async manualSync() {
        const sheetData = await this.fetchFromSheets();
        if (sheetData) {
            this.processSheetData(sheetData);
            alert(`✅ Google Sheets verisi alındı!\n\nSon güncelleme: ${this.lastFetch}`);
        } else {
            alert('❌ Google Sheets verisi alınamadı!\n\nLütfen internet bağlantınızı kontrol edin.');
        }
    }

    async autoSync() {
        const sheetData = await this.fetchFromSheets();
        if (sheetData) {
            this.processSheetData(sheetData);
        }
    }
}

const googleSync = new GoogleSheetsSync();

 // 🚨 YENİ APPS SCRIPT WEB UYGULAMASI URL'NİZ BURADA GÜNCELLENDİ.
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzx0C1kA5LE2j1sZ28SqpvXIPgLtWhqp5LVX0RZxghAKLs_7D20duVWtaVjG1M2kfRb/exec'; 

async function sendUserData(user) {
  // Apps Script'in beklediği JSON anahtarları: name, xp, studyTime
  const dataToSend = {
    name: `${user.name} ${user.surname}`,
    xp: Math.floor(user.totalXP),
    studyTime: Math.floor(user.totalStudyTime) 
  };

  try {
    const response = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(dataToSend), // Kritik 1: Veriyi JSON metnine çevir
      headers: {
        'Content-Type': 'application/json' // Kritik 2: Apps Script'e JSON gönderildiğini bildir
      },
      // 🚨 Kritik 3: Yerel (local) güvenlik kısıtlamasını aşmak için no-cors modu
      mode: 'no-cors' 
    });

    console.log('JSON verisi no-cors modu ile gönderildi. Veri başarıyla Apps Script sunucusuna ulaşmış olmalı.');
    
    // Artık yapılması gereken tek şey Apps Script Yürütmeler (Executions) sekmesini kontrol etmek!
    return true; 

  } catch (error) {
    console.error('Genel Gönderim hatası:', error);
    return false;
  }
}

// 🔥 TÜM VERİLERİ GÖNDER
async function sendAllData() {
  if (!currentUser) {
    showStatus('❌ Önce giriş yapın!', 'error');
    return;
  }

  showStatus('⏳ Tüm veriler arka planda gönderiliyor...', 'sending');
  
  const users = getAllUserData();
  
  if (users.length === 0) {
    showStatus('❌ Gönderilecek veri bulunamadı!', 'error');
    return;
  }
  
  let successCount = 0;
  
  for (const user of users) {
    try {
      const success = await sendUserData(user);
      if (success) {
        successCount++;
        showStatus(`⏳ Gönderiliyor... (${successCount}/${users.length})`, 'sending');
      }
      
      await new Promise(resolve => setTimeout(resolve, 1000));
      
    } catch (error) {
      console.error(`❌ ${user.name} ${user.surname} gönderilemedi:`, error);
    }
  }
  
  if (successCount > 0) {
    showStatus(`✅ ${successCount} kullanıcı verisi gönderildi!`, 'success');
    
    setTimeout(() => {
      googleSync.manualSync();
    }, 3000);
  } else {
    showStatus('❌ Hiçbir veri gönderilemedi!', 'error');
  }
}

// 🔥 SADECE POMODORO VERİLERİNİ GÖNDER
async function sendPomodoroData() {
  if (!currentUser) {
    showStatus('❌ Önce giriş yapın!', 'error', 'pomodoroSendStatus');
    return;
  }

  const userKey = `${currentUser.name}_${currentUser.surname}`;
  const stats = userStats[userKey];
  
  if (!stats || stats.totalXP === 0) {
    showStatus('❌ Gönderilecek Pomodoro verisi yok!', 'error', 'pomodoroSendStatus');
    return;
  }

  showStatus('⏳ Pomodoro verileri arka planda gönderiliyor...', 'sending', 'pomodoroSendStatus');
  
  try {
    const success = await sendUserData({
      name: currentUser.name,
      surname: currentUser.surname,
      totalXP: stats.totalXP,
      totalStudyTime: stats.totalStudyTime
    });
    
    if (success) {
      showStatus('✅ Pomodoro verileri gönderildi!', 'success', 'pomodoroSendStatus');
      
      setTimeout(() => {
        googleSync.manualSync();
      }, 3000);
    } else {
      showStatus('❌ Gönderim başarısız!', 'error', 'pomodoroSendStatus');
    }
  } catch (error) {
    showStatus('❌ Gönderim hatası!', 'error', 'pomodoroSendStatus');
    console.error('Pomodoro veri gönderim hatası:', error);
  }
}

// 🔥 MANUEL VERİ GÖNDERİM
function openManualDataSend() {
  const modal = document.getElementById('dataSendModal');
  if (modal) {
    modal.style.display = 'flex';
    loadStudentsForManualSend();
  }
}

function loadStudentsForManualSend() {
  const studentSelect = document.getElementById('studentSelect');
  if (!studentSelect) return;
  
  studentSelect.innerHTML = '<option value="">Öğrenci seçin...</option>';
  
  students.forEach(student => {
    const option = document.createElement('option');
    option.value = `${student.name}_${student.surname}`;
    option.textContent = `${student.name} ${student.surname}`;
    studentSelect.appendChild(option);
  });
}

function autoFillStudentData() {
  const studentSelect = document.getElementById('studentSelect');
  const xpInput = document.getElementById('xpInput');
  const studyTimeInput = document.getElementById('studyTimeInput');
  
  if (!studentSelect || !xpInput || !studyTimeInput) return;
  
  const selectedStudent = studentSelect.value;
  if (!selectedStudent) return;
  
  const stats = userStats[selectedStudent] || {};
  
  xpInput.value = Math.floor(stats.totalXP || 0);
  studyTimeInput.value = Math.floor(stats.totalStudyTime || 0);
  
  showManualStatus('✅ Öğrenci verileri otomatik dolduruldu!', 'success');
}

async function sendManualData() {
  const studentSelect = document.getElementById('studentSelect');
  const xpInput = document.getElementById('xpInput');
  const studyTimeInput = document.getElementById('studyTimeInput');
  
  if (!studentSelect || !xpInput || !studyTimeInput) return;
  
  const selectedStudent = studentSelect.value;
  if (!selectedStudent) {
    showManualStatus('❌ Öğrenci seçin!', 'error');
    return;
  }
  
  const xp = parseInt(xpInput.value);
  const studyTime = parseInt(studyTimeInput.value);
  
  if (!xp || !studyTime) {
    showManualStatus('❌ XP ve çalışma süresi girin!', 'error');
    return;
  }
  
  const [name, surname] = selectedStudent.split('_');
  
  showManualStatus('⏳ Veri gönderiliyor...', 'sending');
  
  try {
    const success = await sendUserData({
      name: name,
      surname: surname,
      totalXP: xp,
      totalStudyTime: studyTime
    });
    
    if (success) {
      showManualStatus('✅ Veri başarıyla gönderildi!', 'success');
      
      setTimeout(() => {
        const modal = document.getElementById('dataSendModal');
        if (modal) modal.style.display = 'none';
        googleSync.manualSync();
      }, 2000);
    } else {
      showManualStatus('❌ Gönderim başarısız!', 'error');
    }
  } catch (error) {
    showManualStatus('❌ Gönderim hatası!', 'error');
  }
}

// 🔥 TEMEL FONKSİYONLAR
function showStatus(message, type = 'info', elementId = 'sendStatus') {
  const statusEl = document.getElementById(elementId);
  if (statusEl) {
    statusEl.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
  }
}

function showManualStatus(message, type = 'info') {
  const statusEl = document.getElementById('manualSendStatus');
  if (statusEl) {
    statusEl.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
  }
}

function getAllUserData() {
  const users = [];
  
  students.forEach(student => {
    const userKey = `${student.name}_${student.surname}`;
    const stats = userStats[userKey] || {};
    
    if (stats.totalXP > 0) {
      users.push({
        name: student.name,
        surname: student.surname,
        totalXP: stats.totalXP || 0,
        totalStudyTime: stats.totalStudyTime || 0
      });
    }
  });
  
  return users;
}

function showCurrentData() {
  const dataEl = document.getElementById('currentData');
  if (!dataEl) return;
  
  const users = getAllUserData();
  
  if (users.length === 0) {
    dataEl.innerHTML = '<p>Henüz veri bulunmuyor.</p>';
    return;
  }
  
  let html = '';
  users.forEach(user => {
    html += `
      <div style="background:rgba(255,255,255,0.05); padding:10px; margin:5px 0; border-radius:8px;">
        <strong>${user.name} ${user.surname}</strong><br>
        <small>XP: ${Math.floor(user.totalXP)} | Süre: ${Math.floor(user.totalStudyTime)} dk</small>
      </div>
    `;
  });
  
  dataEl.innerHTML = html;
}

// 🔥 SAYAÇ FONKSİYONU
function startCountdown() {
  const targetDate = new Date(currentTargetDate);

  const daysEl = document.getElementById('days');
  const hoursEl = document.getElementById('hours');
  const minutesEl = document.getElementById('minutes');
  const secondsEl = document.getElementById('seconds');

  if (!daysEl || !hoursEl || !minutesEl || !secondsEl) return;

  if (countdownInterval) clearInterval(countdownInterval);

  function updateCountdown() {
    const now = new Date();
    const diff = targetDate - now;

    if (diff <= 0) {
      daysEl.textContent = "00";
      hoursEl.textContent = "00";
      minutesEl.textContent = "00";
      secondsEl.textContent = "00";
      clearInterval(countdownInterval);
      return;
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((diff / (1000 * 60)) % 60);
    const seconds = Math.floor((diff / 1000) % 60);

    daysEl.textContent = days.toString().padStart(2, "0");
    hoursEl.textContent = hours.toString().padStart(2, "0");
    minutesEl.textContent = minutes.toString().padStart(2, "0");
    secondsEl.textContent = seconds.toString().padStart(2, "0");
  }

  updateCountdown();
  countdownInterval = setInterval(updateCountdown, 1000);
}

// 🔥 POMODORO FONKSİYONLARI
function updateTimerDisplay() {
  const pomodoroTimer = document.getElementById('pomodoroTimer');
  if (!pomodoroTimer) return;
  
  const minutes = Math.floor(currentTime / 60);
  const seconds = currentTime % 60;
  pomodoroTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startTimer() {
  if (isRunning) return;
  
  isRunning = true;
  const startPomodoro = document.getElementById('startPomodoro');
  const pausePomodoro = document.getElementById('pausePomodoro');
  
  if (startPomodoro) startPomodoro.disabled = true;
  if (pausePomodoro) pausePomodoro.disabled = false;
  
  startTime = Date.now();
  earnedXP = 0;
  
  pomodoroInterval = setInterval(() => {
    currentTime--;
    updateTimerDisplay();
    
    if (startTime) {
      const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
      earnedXP = elapsedSeconds / 60;
    }
    
    if (currentTime <= 0) {
      completeSession();
    }
  }, 1000);
}

function pauseTimer() {
  if (!isRunning) return;
  
  isRunning = false;
  clearInterval(pomodoroInterval);
  
  const startPomodoro = document.getElementById('startPomodoro');
  const pausePomodoro = document.getElementById('pausePomodoro');
  
  if (startPomodoro) startPomodoro.disabled = false;
  if (pausePomodoro) pausePomodoro.disabled = true;
}

function resetTimer() {
  if (earnedXP > 0.0167) saveEarnedXP();
  
  pauseTimer();
  currentTime = selectedTime * 60;
  updateTimerDisplay();
  
  const startPomodoro = document.getElementById('startPomodoro');
  const pausePomodoro = document.getElementById('pausePomodoro');
  
  if (startPomodoro) startPomodoro.disabled = false;
  if (pausePomodoro) pausePomodoro.disabled = true;
  
  earnedXP = 0;
}

function completeSession() {
  pauseTimer();
  
  if (!currentUser) return;
  
  const userKey = `${currentUser.name}_${currentUser.surname}`;
  if (!userStats[userKey]) {
    userStats[userKey] = {
      monthlyXP: 0, monthlyStudyTime: 0, monthlySessions: 0,
      totalXP: 0, totalStudyTime: 0, totalSessions: 0,
      level: 1, currentStreak: 0, longestStreak: 0,
      lastStudyDate: null, joinDate: new Date().toLocaleString('tr-TR'),
      lastActive: new Date().toLocaleString('tr-TR')
    };
  }
  
  userStats[userKey].monthlyStudyTime += selectedTime;
  userStats[userKey].monthlySessions += 1;
  userStats[userKey].monthlyXP += selectedTime;
  userStats[userKey].totalStudyTime += selectedTime;
  userStats[userKey].totalSessions += 1;
  userStats[userKey].totalXP += selectedTime;
  
  updateStreak();
  
  const newLevel = Math.floor(userStats[userKey].totalXP / 250) + 1;
  if (newLevel > userStats[userKey].level) {
    userStats[userKey].level = newLevel;
    alert(`🎉 Tebrikler! Seviye ${newLevel} oldunuz! 🎉`);
  }
  
  localStorage.setItem('userStats', JSON.stringify(userStats));
  updatePomodoroStats();
  
  setTimeout(() => sendPomodoroData(), 1000);
  
  alert(`🎯 Oturum tamamlandı! +${selectedTime} XP\nToplam: ${userStats[userKey].totalXP} XP\n\n📊 Veriler otomatik kaydediliyor...`);
  
  resetTimer();
}

function saveEarnedXP() {
  if (!currentUser) return;
  
  const userKey = `${currentUser.name}_${currentUser.surname}`;
  if (!userStats[userKey]) {
    userStats[userKey] = {
      monthlyXP: 0, monthlyStudyTime: 0, monthlySessions: 0,
      totalXP: 0, totalStudyTime: 0, totalSessions: 0,
      level: 1, currentStreak: 0, longestStreak: 0,
      lastStudyDate: null, joinDate: new Date().toLocaleString('tr-TR'),
      lastActive: new Date().toLocaleString('tr-TR')
    };
  }
  
  const roundedXP = Math.floor(earnedXP * 100) / 100;
  const roundedMinutes = Math.floor(earnedXP * 100) / 100;
  
  userStats[userKey].monthlyStudyTime += roundedMinutes;
  userStats[userKey].monthlySessions += 1;
  userStats[userKey].monthlyXP += roundedXP;
  userStats[userKey].totalStudyTime += roundedMinutes;
  userStats[userKey].totalSessions += 1;
  userStats[userKey].totalXP += roundedXP;
  
  updateStreak();
  
  const newLevel = Math.floor(userStats[userKey].totalXP / 250) + 1;
  if (newLevel > userStats[userKey].level) {
    userStats[userKey].level = newLevel;
  }
  
  localStorage.setItem('userStats', JSON.stringify(userStats));
  updatePomodoroStats();
  
  if (roundedXP >= 0.5) {
    alert(`⏱️ ${roundedMinutes.toFixed(1)} dakika kaydedildi!\n+${roundedXP.toFixed(1)} XP kazandın!`);
  }
}

function updatePomodoroStats() {
  if (!currentUser) return;
  
  const userKey = `${currentUser.name}_${currentUser.surname}`;
  const stats = userStats[userKey];
  
  const totalStudyTimeEl = document.getElementById('totalStudyTime');
  const currentLevel = document.getElementById('currentLevel');
  const currentXP = document.getElementById('currentXP');
  const currentStreakEl = document.getElementById('currentStreak');
  const xpProgress = document.getElementById('xpProgress');
  const nextLevelXP = document.getElementById('nextLevelXP');
  
  if (stats) {
    const totalXP = stats.totalXP || 0;
    const totalStudyTime = stats.totalStudyTime || 0;
    const level = stats.level || 1;
    const currentStreak = stats.currentStreak || 0;
    
    if (totalStudyTimeEl) totalStudyTimeEl.textContent = Math.floor(totalStudyTime);
    if (currentLevel) currentLevel.textContent = level;
    if (currentXP) currentXP.textContent = Math.floor(totalXP);
    if (currentStreakEl) currentStreakEl.textContent = currentStreak;
    
    const currentLevelXP = (totalXP % 250) || 0;
    const xpPercentage = Math.min(100, Math.max(0, (currentLevelXP / 250) * 100));
    if (xpProgress) xpProgress.style.width = `${xpPercentage}%`;
    if (nextLevelXP) nextLevelXP.textContent = Math.max(0, 250 - currentLevelXP);
  }
}

function updateStreak() {
  if (!currentUser) return;
  
  const userKey = `${currentUser.name}_${currentUser.surname}`;
  const stats = userStats[userKey];
  if (!stats) return;
  
  stats.currentStreak = (stats.currentStreak || 0) + 1;
  if (stats.currentStreak > (stats.longestStreak || 0)) {
    stats.longestStreak = stats.currentStreak;
  }
  
  localStorage.setItem('userStats', JSON.stringify(userStats));
}

// 🔥 RENDER FONKSİYONLARI
function escapeHtml(text){
    if (!text) return '';
    return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function isItemUrgent(date){
    if(!date) return false; 
    const now = new Date(); 
    const diff = (new Date(date) - now) / (1000 * 60 * 60 * 24); 
    return diff >= 0 && diff <= 1;
}

function sortExams(examsToSort, sortType) {
  const sorted = [...examsToSort];
  
  switch(sortType) {
    case "importance-date":
      return sorted.sort((a, b) => {
        const importanceDiff = (b.importance || 3) - (a.importance || 3);
        if (importanceDiff !== 0) return importanceDiff;
        const dateA = a.date ? new Date(a.date) : new Date(0);
        const dateB = b.date ? new Date(b.date) : new Date(0);
        return dateA - dateB;
      });
      
    case "date":
      return sorted.sort((a, b) => {
        const dateA = a.date ? new Date(a.date) : new Date(0);
        const dateB = b.date ? new Date(b.date) : new Date(0);
        return dateA - dateB;
      });
      
    case "importance":
      return sorted.sort((a, b) => (b.importance || 3) - (a.importance || 3));
      
    default:
      return sorted;
  }
}

function renderExams(){
  const list = document.getElementById('examList'); 
  if(!list) return;
  
  if(exams.length===0){
    list.innerHTML='<div class="card"><p>Henüz sınav eklenmedi.</p></div>'; 
    return;
  }
  
  const sortedExams = sortExams(exams, examSortType);
  
  list.innerHTML = sortedExams.map(exam => {
    const imp = importanceLevels[exam.importance||3];
    const urgent = isItemUrgent(exam.date);
    const examTopicsForThisExam = examTopics.filter(topic => topic.examId === exam.id);
    const hasTopics = examTopicsForThisExam.length > 0;
    
    return `
      <div class="exam-card" onclick="toggleExamTopics(this)">
        <div class="exam-header ${hasTopics ? 'has-topics' : ''}">
          <h3>${escapeHtml(exam.title)} <span class="importance-badge ${imp.class}">${imp.icon} ${imp.label}</span>${urgent?'<span style="color:var(--accent-danger);margin-left:8px;">🚨 SON GÜN!</span>':''}</h3>
          ${hasTopics ? '<div class="toggle-icon"><i class="fas fa-chevron-down"></i></div>' : ''}
          ${isAdmin ? `<button class="delete-btn" onclick="event.stopPropagation(); deleteItem('exam',${exam.id})"><i class="fas fa-times"></i></button>` : ''}
        </div>
        <p>${escapeHtml(exam.desc)}</p>
        <p><strong>Tarih:</strong> ${exam.date?new Date(exam.date).toLocaleString('tr-TR'):'-'}</p>
        
        ${hasTopics ? `
          <div class="exam-topics">
            ${examTopicsForThisExam.map(topic => `
              <div class="topic-item">
                <strong>${escapeHtml(topic.title)}</strong>
                ${topic.desc ? `<p>${escapeHtml(topic.desc)}</p>` : ''}
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
  localStorage.setItem('exams',JSON.stringify(exams));
}

function toggleExamTopics(card) {
  const topics = card.querySelector('.exam-topics');
  const header = card.querySelector('.exam-header');
  
  if (!topics) return;
  
  const isActive = topics.classList.contains('active');
  
  document.querySelectorAll('.exam-topics').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.exam-header').forEach(h => h.classList.remove('active'));
  
  if (!isActive) {
    topics.classList.add('active');
    header.classList.add('active');
  }
}

function renderHomeworks(){
  const list=document.getElementById('homeworkList'); 
  if(!list) return;
  
  if(homeworks.length===0){
    list.innerHTML='<div class="card"><p>Henüz ödev eklenmedi.</p></div>'; 
    return;
  }
  
  const sortedHomeworks = [...homeworks].sort((a, b) => {
    const dateA = a.date ? new Date(a.date) : new Date(0);
    const dateB = b.date ? new Date(b.date) : new Date(0);
    return dateA - dateB;
  });
  
  list.innerHTML=sortedHomeworks.map(hw=>{
    const imp = hw.importance ? importanceLevels[hw.importance] : null;
    const urgent=isItemUrgent(hw.date);
    return `<div class="card ${urgent?'urgent-card':''}">
      ${isAdmin?`<button class="delete-btn" onclick="deleteItem('homework',${hw.id})"><i class="fas fa-times"></i></button>`:''}
      <h3>${escapeHtml(hw.title)} ${imp ? `<span class="importance-badge ${imp.class}">${imp.icon} ${imp.label}</span>` : ''}${urgent?'<span style="color:var(--accent-danger);margin-left:8px;">🚨 SON GÜN!</span>':''}</h3>
      <p>${escapeHtml(hw.desc)}</p>
      <p><strong>Teslim Tarihi:</strong> ${hw.date?new Date(hw.date).toLocaleString('tr-TR'):'-'}</p>
    </div>`;
  }).join('');
  localStorage.setItem('homeworks',JSON.stringify(homeworks));
}

function renderHadis(){
  const list=document.getElementById('hadisList'); 
  if(!list) return;
  if(hadises.length===0){
    list.innerHTML='<div class="card"><p>Henüz hadis eklenmedi.</p></div>'; 
    return;
  }
  list.innerHTML=hadises.map(hd=>{
    const imp = hd.importance ? importanceLevels[hd.importance] : null;
    return `<div class="card">
      ${isAdmin?`<button class="delete-btn" onclick="deleteItem('hadis',${hd.id})"><i class="fas fa-times"></i></button>`:''}
      <h3>${escapeHtml(hd.title)} ${imp ? `<span class="importance-badge ${imp.class}">${imp.icon} ${imp.label}</span>` : ''}</h3>
      <p>${escapeHtml(hd.desc)}</p>
    </div>`;
  }).join('');
  localStorage.setItem('hadises',JSON.stringify(hadises));
}

function renderClass(){
  const list=document.getElementById('classList'); 
  if(!list) return;
  if(students.length===0){
    list.innerHTML='<p>Sınıf listesi henüz oluşturulmadı.</p>'; 
    return;
  }
  
  const sorted=[...students].sort((a,b)=>(b.joinTimestamp||0)-(a.joinTimestamp||0));
  list.innerHTML=sorted.map((s,i)=>{
    const userKey = `${s.name}_${s.surname}`;
    const stats = userStats[userKey] || { 
      level: 1, totalXP: 0, totalStudyTime: 0, monthlyXP: 0,
      currentStreak: 0, longestStreak: 0
    };
    
    const level = stats.level || 1;
    const totalXP = stats.totalXP || 0;
    const streak = stats.currentStreak || 0;
    const longestStreak = stats.longestStreak || 0;
    const streakColor = getStreakColor(streak);
    
    return `
      <div class="student-item">
        <strong>${i+1}. ${escapeHtml(s.name)} ${escapeHtml(s.surname)} 
          <span class="student-level">Seviye ${level}</span>
        </strong>
        <div style="display: flex; align-items: center; gap: 8px; margin-top: 6px;">
          <div style="background: ${streakColor}; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; color: white; display: flex; align-items: center; gap: 4px;">
            🔥 ${streak}
          </div>
          <small style="color:#94a3b8;">
            ${Math.floor(totalXP)} XP • ${longestStreak} En Uzun
          </small>
        </div>
      </div>
    `;
  }).join('');
}

function renderUpcoming(){
  const list=document.getElementById('upcomingList'); 
  if(!list) return;
  const now=new Date(); 
  let upcoming=[];
  exams.forEach(e=>{
    if(e.date){
      const diff=(new Date(e.date)-now)/(1000*60*60*24); 
      if(diff>=0&&diff<=2) upcoming.push({type:"Sınav",title:e.title,date:e.date,importance:e.importance});
    }
  });
  homeworks.forEach(h=>{
    if(h.date){
      const diff=(new Date(h.date)-now)/(1000*60*60*24); 
      if(diff>=0&&diff<=2) upcoming.push({type:"Ödev",title:h.title,date:h.date,importance:h.importance});
    }
  });
  if(upcoming.length===0){
    list.innerHTML='<li>Yaklaşan sınav veya ödev bulunmamaktadır.</li>'; 
    return;
  }
  list.innerHTML=upcoming.map(item=>{
    const imp = item.importance ? importanceLevels[item.importance] : null;
    return `<li><strong>${item.type}:</strong> ${escapeHtml(item.title)} ${imp ? `<span class="importance-badge ${imp.class}">${imp.icon}</span>` : ''} <small>(${new Date(item.date).toLocaleString('tr-TR')})</small></li>`;
  }).join('');
}

function renderLeaderboards() {
  renderMonthlyLeaderboard();
  renderTotalLeaderboard();
}

function renderMonthlyLeaderboard() {
  if (!monthlyLeaderboard) return;
  
  const sortedUsers = Object.entries(userStats)
    .map(([userKey, stats]) => {
      const [name, surname] = userKey.split('_');
      return {
        name, surname,
        monthlyXP: stats.monthlyXP || 0,
        monthlyStudyTime: stats.monthlyStudyTime || 0,
        level: stats.level || 1,
        currentStreak: stats.currentStreak || 0,
        totalXP: stats.totalXP || 0
      };
    })
    .sort((a, b) => b.monthlyXP - a.monthlyXP)
    .filter(user => user.monthlyXP > 0 || user.totalXP > 0);
  
  if (sortedUsers.length === 0) {
    monthlyLeaderboard.innerHTML = '<p>Henüz aylık liderlik verisi yok.</p>';
    return;
  }
  
  monthlyLeaderboard.innerHTML = sortedUsers.map((user, index) => {
    const rank = index + 1;
    let medal = '';
    if (rank === 1) medal = '🥇';
    else if (rank === 2) medal = '🥈';
    else if (rank === 3) medal = '🥉';
    
    const streakColor = getStreakColor(user.currentStreak);
    
    return `
      <div class="leaderboard-item">
        <div class="leaderboard-rank">${rank}</div>
        <div class="leaderboard-info">
          <div class="leaderboard-name">${escapeHtml(user.name)} ${escapeHtml(user.surname)} 
            <span style="background: ${streakColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white;">🔥 ${user.currentStreak}</span>
          </div>
          <div class="leaderboard-level">${Math.floor(user.monthlyXP)} XP • ${Math.floor(user.monthlyStudyTime)} dakika</div>
        </div>
        <div class="leaderboard-xp">${medal}</div>
      </div>
    `;
  }).join('');
}

function renderTotalLeaderboard() {
  if (!totalLeaderboard) return;
  
  const sortedUsers = Object.entries(userStats)
    .map(([userKey, stats]) => {
      const [name, surname] = userKey.split('_');
      return {
        name, surname,
        totalXP: stats.totalXP || 0,
        totalStudyTime: stats.totalStudyTime || 0,
        level: stats.level || 1,
        currentStreak: stats.currentStreak || 0
      };
    })
    .sort((a, b) => b.totalXP - a.totalXP)
    .filter(user => user.totalXP > 0);
  
  if (sortedUsers.length === 0) {
    totalLeaderboard.innerHTML = '<p>Henüz toplam liderlik verisi yok.</p>';
    return;
  }
  
  totalLeaderboard.innerHTML = sortedUsers.map((user, index) => {
    const rank = index + 1;
    let medal = '';
    if (rank === 1) medal = '⭐';
    else if (rank === 2) medal = '🌟';
    else if (rank === 3) medal = '✨';
    
    const streakColor = getStreakColor(user.currentStreak);
    
    return `
      <div class="leaderboard-item">
        <div class="leaderboard-rank">${rank}</div>
        <div class="leaderboard-info">
          <div class="leaderboard-name">${escapeHtml(user.name)} ${escapeHtml(user.surname)} 
            <span class="total-badge">Seviye ${user.level}</span>
            <span style="background: ${streakColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white;">🔥 ${user.currentStreak}</span>
          </div>
          <div class="leaderboard-level">${Math.floor(user.totalXP)} XP • ${Math.floor(user.totalStudyTime)} dakika</div>
        </div>
        <div class="leaderboard-xp">${medal}</div>
      </div>
    `;
  }).join('');
}

function getStreakColor(streak) {
  if (streak >= 90) return streakColors[90];
  if (streak >= 60) return streakColors[60];
  if (streak >= 30) return streakColors[30];
  if (streak >= 14) return streakColors[14];
  if (streak >= 7) return streakColors[7];
  if (streak >= 3) return streakColors[3];
  return streakColors[1];
}

// 🔥 EVENT LISTENER KURULUMU
function setupMenuButton() {
  const menuBtn = document.getElementById('menuBtn');
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  
  if (menuBtn && sidebar && overlay) {
    menuBtn.addEventListener('click', function() {
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    });
    
    overlay.addEventListener('click', function() {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
    });
  }
}

function setupSidebarLinks() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  const sections = document.querySelectorAll('.content');
  const sidebarLinks = document.querySelectorAll('.sidebar a[data-section]');
  
  sidebarLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const sectionId = this.getAttribute('data-section');
      sections.forEach(sec => sec.classList.remove('active'));
      const targetSection = document.getElementById(sectionId);
      if (targetSection) targetSection.classList.add('active');
      if (sidebar) sidebar.classList.remove('active');
      if (overlay) overlay.classList.remove('active');
      
      if(sectionId === 'leaderboard') renderLeaderboards();
      if(sectionId === 'data-send') showCurrentData();
    });
  });
}

function setupSyncButton() {
  const header = document.querySelector('header');
  if (!header) return;
  
  if (document.getElementById('syncButton')) return;

  const syncBtn = document.createElement('button');
  syncBtn.id = 'syncButton';
  syncBtn.className = 'sync-button';
  syncBtn.innerHTML = '🔄 Sync';
  syncBtn.title = 'Google Sheets Verilerini Güncelle';
  
  syncBtn.addEventListener('click', () => {
    syncBtn.innerHTML = '⏳...';
    syncBtn.disabled = true;
    
    googleSync.manualSync().finally(() => {
      setTimeout(() => {
        syncBtn.innerHTML = '🔄 Sync';
        syncBtn.disabled = false;
      }, 2000);
    });
  });
  
  const userInfo = document.getElementById('userInfo');
  if (userInfo) header.insertBefore(syncBtn, userInfo);
}

function setupDataSendButton() {
  const header = document.querySelector('header');
  if (!header) return;
  
  if (document.getElementById('dataSendButton')) return;

  const dataSendBtn = document.createElement('button');
  dataSendBtn.id = 'dataSendButton';
  dataSendBtn.className = 'data-send-btn';
  dataSendBtn.innerHTML = '📤 Veri Gönder';
  dataSendBtn.title = 'Verileri Google Forms\'a Gönder';
  dataSendBtn.style.marginLeft = '10px';
  
  dataSendBtn.addEventListener('click', openManualDataSend);
  
  const syncButton = document.getElementById('syncButton');
  if (syncButton) {
    header.insertBefore(dataSendBtn, syncButton.nextSibling);
  } else {
    const userInfo = document.getElementById('userInfo');
    if (userInfo) header.insertBefore(dataSendBtn, userInfo);
  }
}

// 🔥 SAYFA YÜKLENDİĞİNDE
document.addEventListener('DOMContentLoaded', function() {
  // Event listener'ları kur
  setupMenuButton();
  setupSidebarLinks();
  setupSyncButton();
  setupDataSendButton();
  
  // Pomodoro event listener'ları
  const startPomodoro = document.getElementById('startPomodoro');
  const pausePomodoro = document.getElementById('pausePomodoro');
  const resetPomodoro = document.getElementById('resetPomodoro');
  const timeOptions = document.querySelectorAll('.time-option');
  
  if (startPomodoro) startPomodoro.addEventListener('click', startTimer);
  if (pausePomodoro) pausePomodoro.addEventListener('click', pauseTimer);
  if (resetPomodoro) resetPomodoro.addEventListener('click', resetTimer);
  
  if (timeOptions) {
    timeOptions.forEach(option => {
      option.addEventListener('click', function() {
        timeOptions.forEach(opt => opt.classList.remove('active'));
        this.classList.add('active');
        selectedTime = parseInt(this.dataset.minutes);
        currentTime = selectedTime * 60;
        updateTimerDisplay();
      });
    });
  }
  
  // Tatil seçici event listener'ları
  const changeCountdownBtn = document.getElementById('changeCountdownBtn');
  const closeHolidayModal = document.getElementById('closeHolidayModal');
  const selectHolidayBtn = document.getElementById('selectHolidayBtn');
  const holidayOptions = document.querySelectorAll('.holiday-option');
  const holidaySelectorModal = document.getElementById('holidaySelectorModal');
  
  if (changeCountdownBtn && holidaySelectorModal) {
    changeCountdownBtn.addEventListener('click', () => holidaySelectorModal.style.display = 'flex');
  }
  
  if (closeHolidayModal && holidaySelectorModal) {
    closeHolidayModal.addEventListener('click', () => holidaySelectorModal.style.display = 'none');
  }
  
  if (holidaySelectorModal) {
    window.addEventListener('click', (e) => {
      if (e.target === holidaySelectorModal) holidaySelectorModal.style.display = 'none';
    });
  }
  
  if (holidayOptions) {
    holidayOptions.forEach(option => {
      option.addEventListener('click', function() {
        holidayOptions.forEach(opt => opt.classList.remove('active'));
        this.classList.add('active');
      });
    });
  }
  
  if (selectHolidayBtn && holidaySelectorModal) {
    selectHolidayBtn.addEventListener('click', function() {
      const selectedOption = document.querySelector('.holiday-option.active');
      if (selectedOption) {
        currentTargetDate = selectedOption.dataset.target;
        startCountdown();
        
        const holiday = holidayInfo[currentTargetDate];
        const countdownTitle = document.getElementById('countdownTitle');
        const holidayInfoEl = document.getElementById('holidayInfo');
        
        if (countdownTitle) {
          countdownTitle.innerHTML = `${holiday.title}<button class="change-countdown-btn" id="changeCountdownBtn"><i class="fas fa-exchange-alt"></i> Değiştir</button>`;
        }
        
        if (holidayInfoEl) holidayInfoEl.textContent = holiday.info;
        
        holidaySelectorModal.style.display = 'none';
      }
    });
  }
  
  // Manuel veri gönderim modalı event listener'ları
  const closeDataSendModal = document.getElementById('closeDataSendModal');
  const dataSendModal = document.getElementById('dataSendModal');
  const studentSelect = document.getElementById('studentSelect');
  
  if (closeDataSendModal && dataSendModal) {
    closeDataSendModal.addEventListener('click', () => dataSendModal.style.display = 'none');
  }
  
  if (dataSendModal) {
    window.addEventListener('click', (e) => {
      if (e.target === dataSendModal) dataSendModal.style.display = 'none';
    });
  }
  
  if (studentSelect) {
    studentSelect.addEventListener('change', autoFillStudentData);
  }
  
  // Giriş butonu event listener
  const loginBtn = document.getElementById('loginBtn');
  if (loginBtn) {
    loginBtn.addEventListener('click', function(){
      const studentName = document.getElementById('studentName');
      const studentSurname = document.getElementById('studentSurname');
      
      if (!studentName || !studentSurname) return;
      
      const name = studentName.value.trim();
      const surname = studentSurname.value.trim();
      
      if(!name || !surname){
        alert("Lütfen ad ve soyad girin!");
        return;
      }
      
      currentUser = {name, surname};
      
      const userKey = `${name}_${surname}`;
      if(!userStats[userKey]) {
        userStats[userKey] = {
          monthlyXP: 0, monthlyStudyTime: 0, monthlySessions: 0,
          totalXP: 0, totalStudyTime: 0, totalSessions: 0,
          level: 1, currentStreak: 0, longestStreak: 0,
          lastStudyDate: null, joinDate: new Date().toLocaleString('tr-TR'),
          lastActive: new Date().toLocaleString('tr-TR')
        };
      }
      
      localStorage.setItem('userStats', JSON.stringify(userStats));
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      
      const loginModal = document.getElementById('loginModal');
      if (loginModal) loginModal.style.display = 'none';
      
      updateUI();
    });
  }

  // Admin girişi
  const adminSwitch = document.getElementById('adminSwitch');
  if (adminSwitch) {
    adminSwitch.addEventListener('click', function(){
      const pass = prompt("Admin şifresini girin:");
      if(pass === "Gityazarkandayım"){
        isAdmin = true;
        updateUI(); 
      } else {
        alert("Şifre yanlış!");
      }
    });
  }

  // İçerik ekleme modalı
  const addBtn = document.getElementById('addBtn');
  const addModal = document.getElementById('addModal');
  const closeAddModal = document.getElementById('closeAddModal');
  const saveContentBtn = document.getElementById('saveContentBtn');
  
  if (addBtn) {
    addBtn.addEventListener('click', function(){
      if(!currentUser){
        alert('Lütfen önce giriş yapın!'); 
        loginModal.style.display='flex';
        return;
      }
      if(!isAdmin){
        alert('Sadece admin içerik ekleyebilir!'); 
        return;
      }
      if (addModal) addModal.style.display = 'flex';
    });
  }
  
  if (closeAddModal && addModal) {
    closeAddModal.addEventListener('click', () => addModal.style.display = 'none');
  }
  
  if (addModal) {
    window.addEventListener('click', (e) => {
      if (e.target === addModal) addModal.style.display = 'none';
    });
  }
  
  if (saveContentBtn) {
    saveContentBtn.addEventListener('click', function(){
      const type = document.getElementById('contentType').value;
      const title = document.getElementById('contentTitle').value.trim();
      const desc = document.getElementById('contentDesc').value.trim();
      const date = document.getElementById('contentDate').value;
      const importance = parseInt(document.getElementById('contentImportance').value);
      
      if(!title){
        alert('Başlık girin!'); 
        return;
      }
      
      if(type === "exam" && importance === 0) {
        alert('Sınavlar için önem seviyesi seçmelisiniz!');
        return;
      }
      
      if(type==="exam"){
        exams.push({id:nextId++,title,desc,date,importance: importance === 0 ? 3 : importance}); 
        renderExams();
      }
      else if(type==="homework"){
        homeworks.push({id:nextId++,title,desc,date,importance: importance === 0 ? null : importance}); 
        renderHomeworks();
      }
      else if(type==="hadis"){
        hadises.push({id:nextId++,title,desc,date,importance: importance === 0 ? null : importance}); 
        renderHadis();
      }
      
      document.getElementById('contentTitle').value='';
      document.getElementById('contentDesc').value='';
      document.getElementById('contentDate').value='';
      if (addModal) addModal.style.display = 'none';
      renderUpcoming();
    });
  }

  // Sınav sıralama event listener'ları
  const examSorting = document.getElementById('examSorting');
  if(examSorting) {
    examSorting.addEventListener('click', (e) => {
      if(e.target.classList.contains('sort-option')) {
        document.querySelectorAll('.sort-option').forEach(opt => opt.classList.remove('active'));
        e.target.classList.add('active');
        examSortType = e.target.dataset.sort;
        renderExams();
      }
    });
  }

  // Uygulamayı başlat
  initializeApp();
});

// 🔥 UYGULAMA BAŞLATMA
function updateUI(){
  if(currentUser){
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    const welcomeMessage = document.getElementById('welcomeMessage');
    
    if (userInfo) userInfo.style.display = 'block';
    if (userName) userName.textContent = isAdmin ? "Admin" : `${currentUser.name} ${currentUser.surname}`;
    if (welcomeMessage) {
      welcomeMessage.textContent = isAdmin ? 
        `Hoş geldiniz Admin!` : 
        `Hoş geldiniz ${currentUser.name} ${currentUser.surname}! Portalınıza hoş geldiniz.`;
    }
  }
}

function deleteItem(type,id){
  if(type==="exam"){
    exams = exams.filter(e=>e.id!==id);
    examTopics = examTopics.filter(topic => topic.examId !== id);
    localStorage.setItem('examTopics', JSON.stringify(examTopics));
    renderExams();
  }
  else if(type==="homework"){
    homeworks=homeworks.filter(h=>h.id!==id); 
    renderHomeworks();
  }
  else if(type==="hadis"){
    hadises=hadises.filter(h=>h.id!==id); 
    renderHadis();
  }
  renderUpcoming();
  localStorage.setItem('exams',JSON.stringify(exams));
  localStorage.setItem('homeworks',JSON.stringify(homeworks));
  localStorage.setItem('hadises',JSON.stringify(hadises));
}

async function initializeApp() {
  try {
    // Local storage'dan verileri yükle
    const savedUser = localStorage.getItem('currentUser');
    const savedStudents = localStorage.getItem('students');
    const savedExams = localStorage.getItem('exams');
    const savedHomeworks = localStorage.getItem('homeworks');
    const savedHadis = localStorage.getItem('hadises');
    const savedTopics = localStorage.getItem('examTopics');
    const savedStats = localStorage.getItem('userStats');

    if(savedUser) currentUser = JSON.parse(savedUser);
    if(savedStudents) students = JSON.parse(savedStudents);
    if(savedExams) exams = JSON.parse(savedExams);
    if(savedHomeworks) homeworks = JSON.parse(savedHomeworks);
    if(savedHadis) hadises = JSON.parse(savedHadis);
    if(savedTopics) examTopics = JSON.parse(savedTopics);
    if(savedStats) userStats = JSON.parse(savedStats);

    if(currentUser){
      const loginModal = document.getElementById('loginModal');
      if (loginModal) loginModal.style.display = 'none';
      updateUI();
    }

    // Google Sheets'ten verileri çek
    await googleSync.autoSync();

    // UI'ı güncelle
    renderExams(); 
    renderHomeworks(); 
    renderHadis(); 
    renderClass(); 
    renderUpcoming();
    updatePomodoroStats();
    startCountdown();
    renderLeaderboards();
    showCurrentData();
    
    console.log('✅ Uygulama başlatıldı - TÜM ÖZELLİKLER ÇALIŞIYOR!');
    
  } catch (error) {
    console.error('❌ Uygulama başlatma hatası:', error);
  }
}

// AYLIK SIFIRLAMA
function checkMonthlyReset() {
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  const lastReset = localStorage.getItem('lastMonthlyReset');
  
  if (!lastReset) {
    resetMonthlyStats();
    localStorage.setItem('lastMonthlyReset', `${currentYear}-${currentMonth}`);
    return;
  }
  
  const [lastYear, lastMonth] = lastReset.split('-').map(Number);
  
  if (currentYear > lastYear || (currentYear === lastYear && currentMonth > lastMonth)) {
    resetMonthlyStats();
    localStorage.setItem('lastMonthlyReset', `${currentYear}-${currentMonth}`);
  }
}

function resetMonthlyStats() {
  Object.keys(userStats).forEach(userKey => {
    if (userStats[userKey]) {
      userStats[userKey].monthlyXP = 0;
      userStats[userKey].monthlyStudyTime = 0;
      userStats[userKey].monthlySessions = 0;
    }
  });
  localStorage.setItem('userStats', JSON.stringify(userStats));
}

// Sayfa her açıldığında aylık sıfırlama kontrolü
setInterval(checkMonthlyReset, 60 * 60 * 1000);

console.log('🚀 TÜM SİSTEM ÇALIŞIYOR! Her özellik aktif!');
</script>
