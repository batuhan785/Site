<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Öğrenci Portalı</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
/* ÖNCEKİ TÜM CSS KODLARI BURADA AYNI KALACAK */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins','Segoe UI',sans-serif;}
:root {
  --primary-dark: #1e3a8a;
  --accent-warning: #f59e0b;
  --accent-danger: #dc2626;
  --accent-success: #059669;
  --bg-dark: #0f172a;
  --bg-card: #1e293b;
  --text-light: #f8fafc;
  --border-color: #334155;
}
body{background:linear-gradient(135deg, var(--bg-dark), #1e3a8a, #0f766e);color:var(--text-light);min-height:100vh;overflow-x:hidden;}
/* ... TÜM DİĞER CSS KODLARI AYNI ... */
</style>
</head>
<body>

<!-- HTML YAPISI AYNI KALACAK -->
<div id="loginModal" class="login-modal">
  <!-- ... login modal içeriği ... -->
</div>

<div class="overlay" id="overlay"></div>

<header>
  <div class="menu-btn" id="menuBtn"><i class="fas fa-bars"></i></div>
  <div class="header-title">Öğrenci Portalı</div>
  <div class="user-info" id="userInfo" style="display:none;">Hoş geldiniz<br><small id="userName"></small></div>
</header>

<div class="sidebar" id="sidebar">
  <!-- ... sidebar menü ... -->
</div>

<div class="container">
  <!-- ... tüm içerik bölümleri ... -->
</div>

<div class="add-btn" id="addBtn"><i class="fas fa-plus"></i></div>

<!-- Modal yapıları -->
<div id="addModal" class="modal">
  <!-- ... modal içeriği ... -->
</div>

<script>
// 🔥 GOOGLE SHEETS SYNC SİSTEMİ - BAŞLANGIÇ
// ============================================

const SHEET_ID = '1UVpxOHs92qbRLestRIGuUfUYQ58NVJn3AJALSwiPPfY';
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;

class GoogleSheetsSync {
    constructor() {
        this.sheetData = null;
        this.lastFetch = null;
    }

    async fetchFromSheets() {
        try {
            console.log('📥 Google Sheets verisi çekiliyor...');
            const response = await fetch(CSV_URL);
            const csvText = await response.text();
            
            this.sheetData = this.parseCSVData(csvText);
            this.lastFetch = new Date().toLocaleString('tr-TR');
            
            console.log('✅ Google Sheets verisi alındı:', this.sheetData);
            return this.sheetData;
        } catch (error) {
            console.error('❌ Google Sheets verisi alınamadı:', error);
            return null;
        }
    }

    parseCSVData(csvText) {
        if (!csvText) return [];
        const lines = csvText.split(/\r\n|\n/);
        if (lines.length < 2) return [];

        const separator = (csvText.indexOf('\t') !== -1) ? '\t' : ',';
        const headers = lines[0].split(separator).map(header => header.trim().toLowerCase());

        const result = [];
        
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const values = lines[i].split(separator);
            const rowData = {};
            let isEmptyRow = true;

            headers.forEach((header, index) => {
                const value = values[index] ? values[index].trim() : '';
                rowData[header] = value;
                if (value) isEmptyRow = false;
            });

            if (!isEmptyRow && rowData.type) {
                result.push(rowData);
            }
        }
        return result;
    }

    processSheetData(sheetData) {
        if (!sheetData || sheetData.length === 0) return;

        console.log('🔄 Sheets verisi işleniyor...', sheetData);

        const sheetExams = sheetData.filter(row => row.type === 'exam').map(row => ({
            id: parseInt(row.id) || Date.now() + Math.random(),
            title: row.title || '',
            desc: row.desc || '',
            date: row.date || null,
            importance: parseInt(row.importance) || 3
        }));

        const sheetHomeworks = sheetData.filter(row => row.type === 'homework').map(row => ({
            id: parseInt(row.id) || Date.now() + Math.random(),
            title: row.title || '',
            desc: row.desc || '',
            date: row.date || null,
            importance: parseInt(row.importance) || null
        }));

        const sheetHadises = sheetData.filter(row => row.type === 'hadis').map(row => ({
            id: parseInt(row.id) || Date.now() + Math.random(),
            title: row.title || '',
            desc: row.desc || '',
            date: row.date || null,
            importance: parseInt(row.importance) || null
        }));

        const sheetStudents = sheetData.filter(row => row.type === 'student').map(row => ({
            name: row.name || '',
            surname: row.surname || '',
            joinDate: row.joindate || new Date().toLocaleString('tr-TR'),
            joinTimestamp: parseInt(row.jointimestamp) || Date.now()
        }));

        console.log('📊 İşlenen veriler:', {
            exams: sheetExams.length,
            homeworks: sheetHomeworks.length,
            hadises: sheetHadises.length,
            students: sheetStudents.length
        });

        if (sheetExams.length > 0) {
            exams = sheetExams;
            localStorage.setItem('exams', JSON.stringify(exams));
            console.log('✅ Sınavlar güncellendi:', exams);
        }
        
        if (sheetHomeworks.length > 0) {
            homeworks = sheetHomeworks;
            localStorage.setItem('homeworks', JSON.stringify(homeworks));
            console.log('✅ Ödevler güncellendi:', homeworks);
        }
        
        if (sheetHadises.length > 0) {
            hadises = sheetHadises;
            localStorage.setItem('hadises', JSON.stringify(hadises));
            console.log('✅ Hadisler güncellendi:', hadises);
        }
        
        if (sheetStudents.length > 0) {
            students = sheetStudents;
            localStorage.setItem('students', JSON.stringify(students));
            console.log('✅ Öğrenciler güncellendi:', students);
        }

        this.updateUI();
        console.log('🔄 Sheets verisi işlendi');
    }

    updateUI() {
        if (window.renderExams) {
            renderExams();
            console.log('✅ Sınavlar render edildi');
        }
        if (window.renderHomeworks) {
            renderHomeworks();
            console.log('✅ Ödevler render edildi');
        }
        if (window.renderHadis) {
            renderHadis();
            console.log('✅ Hadisler render edildi');
        }
        if (window.renderClass) {
            renderClass();
            console.log('✅ Sınıf render edildi');
        }
        if (window.renderExamTopics) renderExamTopics();
        if (window.renderUpcoming) renderUpcoming();
        if (window.renderLeaderboards) renderLeaderboards();
        if (window.updatePomodoroStats) updatePomodoroStats();
    }

    async manualSync() {
        const sheetData = await this.fetchFromSheets();
        if (sheetData) {
            this.processSheetData(sheetData);
            alert(`✅ Google Sheets verisi alındı!\n\nSon güncelleme: ${this.lastFetch}\n\n📊 İstatistikler:\n- ${sheetData.filter(r => r.type === 'exam').length} sınav\n- ${sheetData.filter(r => r.type === 'homework').length} ödev\n- ${sheetData.filter(r => r.type === 'hadis').length} hadis\n- ${sheetData.filter(r => r.type === 'student').length} öğrenci`);
        } else {
            alert('❌ Google Sheets verisi alınamadı!\n\nLütfen internet bağlantınızı kontrol edin.');
        }
    }

    async autoSync() {
        const sheetData = await this.fetchFromSheets();
        if (sheetData) {
            this.processSheetData(sheetData);
        }
    }
}

const googleSync = new GoogleSheetsSync();

// 🔥 DEĞİŞKENLER - MEVCUT KODLA UYUMLU
// =====================================

let exams = [];
let homeworks = [];
let hadises = [];
let examTopics = [];
let students = [];
let userStats = {};
let currentUser = null;
let isAdmin = false;
let nextId = 100;
let examSortType = "importance-date";

// Pomodoro değişkenleri
let pomodoroInterval = null;
let currentTime = 30 * 60;
let isRunning = false;
let selectedTime = 30;
let earnedXP = 0;
let startTime = null;

// Önem seviyeleri
const importanceLevels = {
  1:{label:"Düşük", icon:"⭐", class:"importance-1"},
  2:{label:"Orta", icon:"⭐⭐", class:"importance-2"},
  3:{label:"Yüksek", icon:"⭐⭐⭐", class:"importance-3"},
  4:{label:"Çok Yüksek", icon:"⭐⭐⭐⭐", class:"importance-4"},
  5:{label:"KRİTİK", icon:"⭐⭐⭐⭐⭐", class:"importance-5"},
  0:{label:"Kullanılmıyor", icon:"", class:"importance-1"}
};

// STREAK RENK SİSTEMİ
const streakColors = {
  1: "#6b7280",   // Gri - Yeni başladı
  3: "#f59e0b",   // Turuncu - Ateş başladı
  7: "#ef4444",   // Kırmızı - İyi gidiyor
  14: "#dc2626",  // Koyu kırmızı - Harika
  30: "#7c3aed",  // Mor - Efsane
  60: "#10b981",  // Yeşil - Destansı
  90: "#06b6d4"   // Camgöbeği - Efsanevi
};

// 🔥 EKSİK FONKSİYONLARI TAMAMLAYALIM
// =====================================

// SINAVLARI RENDER ET
function renderExams() {
    const examList = document.getElementById('examList');
    if (!examList) return;
    
    if (exams.length === 0) {
        examList.innerHTML = '<div class="card"><p>Henüz sınav eklenmedi.</p></div>';
        return;
    }

    let sortedExams = [...exams];
    
    // Sıralama tipine göre filtrele
    switch(examSortType) {
        case 'importance-date':
            sortedExams.sort((a, b) => {
                if (b.importance !== a.importance) return b.importance - a.importance;
                return new Date(a.date) - new Date(b.date);
            });
            break;
        case 'date':
            sortedExams.sort((a, b) => new Date(a.date) - new Date(b.date));
            break;
        case 'importance':
            sortedExams.sort((a, b) => b.importance - a.importance);
            break;
    }

    examList.innerHTML = sortedExams.map(exam => {
        const importance = importanceLevels[exam.importance] || importanceLevels[3];
        const examDate = new Date(exam.date);
        const now = new Date();
        const timeDiff = examDate - now;
        const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
        
        let dateInfo = '';
        if (daysLeft < 0) {
            dateInfo = `<span style="color: #ef4444;">⏰ Geçmiş</span>`;
        } else if (daysLeft === 0) {
            dateInfo = `<span style="color: #dc2626;">🔥 Bugün!</span>`;
        } else if (daysLeft === 1) {
            dateInfo = `<span style="color: #f59e0b;">⏳ Yarın!</span>`;
        } else if (daysLeft <= 7) {
            dateInfo = `<span style="color: #f59e0b;">⏳ ${daysLeft} gün kaldı</span>`;
        } else {
            dateInfo = `<span style="color: #10b981;">📅 ${daysLeft} gün kaldı</span>`;
        }

        const isUrgent = daysLeft <= 2 && exam.importance >= 4;
        const cardClass = isUrgent ? 'card urgent-card' : 'card';

        return `
            <div class="${cardClass}">
                ${isAdmin ? `<button class="delete-btn" onclick="deleteExam(${exam.id})"><i class="fas fa-times"></i></button>` : ''}
                <h3>${escapeHtml(exam.title)} <span class="importance-badge ${importance.class}">${importance.icon} ${importance.label}</span></h3>
                <p>${escapeHtml(exam.desc)}</p>
                <p><strong>Tarih:</strong> ${new Date(exam.date).toLocaleString('tr-TR')}</p>
                <p><strong>Durum:</strong> ${dateInfo}</p>
            </div>
        `;
    }).join('');
}

// ÖDEVLERİ RENDER ET
function renderHomeworks() {
    const homeworkList = document.getElementById('homeworkList');
    if (!homeworkList) return;
    
    if (homeworks.length === 0) {
        homeworkList.innerHTML = '<div class="card"><p>Henüz ödev eklenmedi.</p></div>';
        return;
    }

    homeworkList.innerHTML = homeworks.map(hw => {
        const hwDate = new Date(hw.date);
        const now = new Date();
        const timeDiff = hwDate - now;
        const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
        
        let dateInfo = '';
        if (daysLeft < 0) {
            dateInfo = `<span style="color: #ef4444;">⏰ Geçmiş</span>`;
        } else if (daysLeft === 0) {
            dateInfo = `<span style="color: #dc2626;">🔥 Bugün teslim!</span>`;
        } else if (daysLeft === 1) {
            dateInfo = `<span style="color: #f59e0b;">⏳ Yarın teslim</span>`;
        } else if (daysLeft <= 3) {
            dateInfo = `<span style="color: #f59e0b;">⏳ ${daysLeft} gün kaldı</span>`;
        } else {
            dateInfo = `<span style="color: #10b981;">📅 ${daysLeft} gün kaldı</span>`;
        }

        const importance = hw.importance ? importanceLevels[hw.importance] : null;
        const importanceBadge = importance ? `<span class="importance-badge ${importance.class}">${importance.icon} ${importance.label}</span>` : '';

        return `
            <div class="card">
                ${isAdmin ? `<button class="delete-btn" onclick="deleteHomework(${hw.id})"><i class="fas fa-times"></i></button>` : ''}
                <h3>${escapeHtml(hw.title)} ${importanceBadge}</h3>
                <p>${escapeHtml(hw.desc)}</p>
                <p><strong>Teslim Tarihi:</strong> ${new Date(hw.date).toLocaleString('tr-TR')}</p>
                <p><strong>Durum:</strong> ${dateInfo}</p>
            </div>
        `;
    }).join('');
}

// HADİSLERİ RENDER ET
function renderHadis() {
    const hadisList = document.getElementById('hadisList');
    if (!hadisList) return;
    
    if (hadises.length === 0) {
        hadisList.innerHTML = '<div class="card"><p>Henüz hadis eklenmedi.</p></div>';
        return;
    }

    hadisList.innerHTML = hadises.map(hadis => `
        <div class="card">
            ${isAdmin ? `<button class="delete-btn" onclick="deleteHadis(${hadis.id})"><i class="fas fa-times"></i></button>` : ''}
            <h3>${escapeHtml(hadis.title)}</h3>
            <p><em>"${escapeHtml(hadis.desc)}"</em></p>
            ${hadis.date ? `<p><small>Eklenme: ${new Date(hadis.date).toLocaleDateString('tr-TR')}</small></p>` : ''}
        </div>
    `).join('');
}

// SINIF LİSTESİNİ RENDER ET
function renderClass() {
    const classList = document.getElementById('classList');
    if (!classList) return;
    
    if (students.length === 0) {
        classList.innerHTML = '<p>Henüz öğrenci kaydı yok.</p>';
        return;
    }

    // Öğrencileri katılım tarihine göre sırala
    const sortedStudents = [...students].sort((a, b) => a.joinTimestamp - b.joinTimestamp);

    classList.innerHTML = sortedStudents.map((student, index) => {
        const userKey = `${student.name}_${student.surname}`;
        const stats = userStats[userKey];
        const level = stats ? stats.level : 1;
        const totalXP = stats ? Math.floor(stats.totalXP || 0) : 0;
        const currentStreak = stats ? stats.currentStreak || 0 : 0;
        const streakColor = getStreakColor(currentStreak);

        return `
            <div class="student-item">
                <strong>${index + 1}. ${escapeHtml(student.name)} ${escapeHtml(student.surname)}</strong>
                <span class="student-level">Seviye ${level}</span>
                ${currentStreak > 0 ? `<span style="background: ${streakColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white; margin-left: 5px;">🔥 ${currentStreak}</span>` : ''}
                <br>
                <small>${totalXP} XP • Katılım: ${student.joinDate}</small>
            </div>
        `;
    }).join('');
}

// YAKLAŞAN SINAV/ÖDEV LİSTESİ
function renderUpcoming() {
    const upcomingList = document.getElementById('upcomingList');
    const upcomingCard = document.getElementById('upcomingCard');
    if (!upcomingList || !upcomingCard) return;

    const now = new Date();
    const twoDaysFromNow = new Date(now.getTime() + 2 * 24 * 60 * 60 * 1000);

    const upcomingItems = [
        ...exams.map(exam => ({
            ...exam,
            type: 'exam',
            date: new Date(exam.date)
        })),
        ...homeworks.map(hw => ({
            ...hw,
            type: 'homework', 
            date: new Date(hw.date)
        }))
    ].filter(item => {
        return item.date > now && item.date <= twoDaysFromNow;
    }).sort((a, b) => a.date - b.date);

    if (upcomingItems.length === 0) {
        upcomingList.innerHTML = '<li>Yaklaşan sınav veya ödev bulunmamaktadır.</li>';
        return;
    }

    upcomingList.innerHTML = upcomingItems.map(item => {
        const hoursLeft = Math.ceil((item.date - now) / (1000 * 60 * 60));
        const importance = importanceLevels[item.importance] || importanceLevels[3];
        
        return `
            <li>
                <strong>${item.type === 'exam' ? '📝 Sınav' : '📚 Ödev'}:</strong> ${escapeHtml(item.title)}
                <span class="importance-badge ${importance.class}">${importance.icon}</span>
                <br>
                <small>${item.date.toLocaleString('tr-TR')} (${hoursLeft} saat kaldı)</small>
            </li>
        `;
    }).join('');
}

// SINAV KONULARINI RENDER ET
function renderExamTopics() {
    // Bu fonksiyon mevcut kodda var, olduğu gibi kalacak
}

// LİDERLİK TABLOLARI
function renderLeaderboards() {
    renderMonthlyLeaderboard();
    renderTotalLeaderboard();
}

function renderMonthlyLeaderboard() {
    if (!monthlyLeaderboard) return;
    
    const sortedUsers = Object.entries(userStats)
        .map(([userKey, stats]) => {
            const [name, surname] = userKey.split('_');
            return {
                name,
                surname,
                monthlyXP: stats.monthlyXP || 0,
                monthlyStudyTime: stats.monthlyStudyTime || 0,
                level: stats.level || 1,
                currentStreak: stats.currentStreak || 0
            };
        })
        .sort((a, b) => b.monthlyXP - a.monthlyXP)
        .filter(user => user.monthlyXP > 0);

    if (sortedUsers.length === 0) {
        monthlyLeaderboard.innerHTML = '<p>Henüz aylık liderlik verisi yok.</p>';
        return;
    }

    monthlyLeaderboard.innerHTML = sortedUsers.map((user, index) => {
        const rank = index + 1;
        let medal = '';
        if (rank === 1) medal = '🥇';
        else if (rank === 2) medal = '🥈';
        else if (rank === 3) medal = '🥉';
        
        const streakColor = getStreakColor(user.currentStreak);
        
        return `
            <div class="leaderboard-item">
                <div class="leaderboard-rank">${rank}</div>
                <div class="leaderboard-info">
                    <div class="leaderboard-name">${escapeHtml(user.name)} ${escapeHtml(user.surname)} 
                        <span style="background: ${streakColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white;">🔥 ${user.currentStreak}</span>
                    </div>
                    <div class="leaderboard-level">${Math.floor(user.monthlyXP)} XP • ${Math.floor(user.monthlyStudyTime)} dakika</div>
                </div>
                <div class="leaderboard-xp">${medal}</div>
            </div>
        `;
    }).join('');
}

function renderTotalLeaderboard() {
    if (!totalLeaderboard) return;
    
    const sortedUsers = Object.entries(userStats)
        .map(([userKey, stats]) => {
            const [name, surname] = userKey.split('_');
            return {
                name,
                surname,
                totalXP: stats.totalXP || 0,
                totalStudyTime: stats.totalStudyTime || 0,
                level: stats.level || 1,
                currentStreak: stats.currentStreak || 0
            };
        })
        .sort((a, b) => b.totalXP - a.totalXP)
        .filter(user => user.totalXP > 0);

    if (sortedUsers.length === 0) {
        totalLeaderboard.innerHTML = '<p>Henüz toplam liderlik verisi yok.</p>';
        return;
    }

    totalLeaderboard.innerHTML = sortedUsers.map((user, index) => {
        const rank = index + 1;
        let medal = '';
        if (rank === 1) medal = '⭐';
        else if (rank === 2) medal = '🌟';
        else if (rank === 3) medal = '✨';
        
        const streakColor = getStreakColor(user.currentStreak);
        
        return `
            <div class="leaderboard-item">
                <div class="leaderboard-rank">${rank}</div>
                <div class="leaderboard-info">
                    <div class="leaderboard-name">${escapeHtml(user.name)} ${escapeHtml(user.surname)} 
                        <span class="total-badge">Seviye ${user.level}</span>
                        <span style="background: ${streakColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white;">🔥 ${user.currentStreak}</span>
                    </div>
                    <div class="leaderboard-level">${Math.floor(user.totalXP)} XP • ${Math.floor(user.totalStudyTime)} dakika</div>
                </div>
                <div class="leaderboard-xp">${medal}</div>
            </div>
        `;
    }).join('');
}

// YARDIMCI FONKSİYONLAR
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getStreakColor(streak) {
    if (streak >= 90) return streakColors[90];
    if (streak >= 60) return streakColors[60];
    if (streak >= 30) return streakColors[30];
    if (streak >= 14) return streakColors[14];
    if (streak >= 7) return streakColors[7];
    if (streak >= 3) return streakColors[3];
    return streakColors[1];
}

// SİLME FONKSİYONLARI
function deleteExam(id) {
    if (!isAdmin) return;
    exams = exams.filter(exam => exam.id !== id);
    localStorage.setItem('exams', JSON.stringify(exams));
    renderExams();
    renderUpcoming();
}

function deleteHomework(id) {
    if (!isAdmin) return;
    homeworks = homeworks.filter(hw => hw.id !== id);
    localStorage.setItem('homeworks', JSON.stringify(homeworks));
    renderHomeworks();
    renderUpcoming();
}

function deleteHadis(id) {
    if (!isAdmin) return;
    hadises = hadises.filter(hadis => hadis.id !== id);
    localStorage.setItem('hadises', JSON.stringify(hadises));
    renderHadis();
}

// GERİ KALAN TÜM FONKSİYONLAR (POMODORO, COUNTDOWN, vs.)
// ======================================================

// Countdown fonksiyonu
function startCountdown() {
    const targetDate = new Date('2025-11-07T00:00:00').getTime();
    
    function updateCountdown() {
        const now = new Date().getTime();
        const distance = targetDate - now;
        
        if (distance < 0) {
            document.getElementById('days').textContent = '00';
            document.getElementById('hours').textContent = '00';
            document.getElementById('minutes').textContent = '00';
            document.getElementById('seconds').textContent = '00';
            return;
        }
        
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        document.getElementById('days').textContent = days.toString().padStart(2, '0');
        document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
        document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
        document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
    }
    
    updateCountdown();
    setInterval(updateCountdown, 1000);
}

// Sync butonu ekleme
function setupSyncButton() {
    const header = document.querySelector('header');
    if (!header) return;
    if (document.getElementById('syncButton')) return;

    const syncBtn = document.createElement('button');
    syncBtn.id = 'syncButton';
    syncBtn.innerHTML = '🔄';
    syncBtn.style.background = 'none';
    syncBtn.style.border = 'none';
    syncBtn.style.color = 'var(--accent-warning)';
    syncBtn.style.fontSize = '20px';
    syncBtn.style.marginLeft = '10px';
    syncBtn.style.cursor = 'pointer';
    syncBtn.title = 'Google Sheets Sync';
    
    syncBtn.addEventListener('click', () => {
        googleSync.manualSync();
    });
    
    header.appendChild(syncBtn);
}

// SAYFA YÜKLENDİĞİNDE
window.addEventListener('load', () => {
    // Local storage'dan verileri yükle
    const savedUser = localStorage.getItem('currentUser');
    const savedStudents = localStorage.getItem('students');
    const savedExams = localStorage.getItem('exams');
    const savedHomeworks = localStorage.getItem('homeworks');
    const savedHadis = localStorage.getItem('hadises');
    const savedTopics = localStorage.getItem('examTopics');
    const savedStats = localStorage.getItem('userStats');

    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        loginModal.style.display = 'none';
        updateUI();
    }
    if (savedStudents) students = JSON.parse(savedStudents);
    if (savedExams) exams = JSON.parse(savedExams);
    if (savedHomeworks) homeworks = JSON.parse(savedHomeworks);
    if (savedHadis) hadises = JSON.parse(savedHadis);
    if (savedTopics) examTopics = JSON.parse(savedTopics);
    if (savedStats) userStats = JSON.parse(savedStats);

    // Google Sheets'ten otomatik sync
    setTimeout(() => {
        googleSync.autoSync();
    }, 2000);

    // Sync butonunu kur
    setupSyncButton();

    // UI'ı render et
    renderExams(); 
    renderHomeworks(); 
    renderHadis(); 
    renderClass(); 
    renderUpcoming(); 
    renderExamTopics();
    updatePomodoroStats();
    startCountdown();
    renderLeaderboards();
});

// POMODORO TIMER FONKSİYONLARI
// =============================
// (Bu kısım mevcut kodda var, olduğu gibi kalacak)

function updateTimerDisplay() {
    const minutes = Math.floor(currentTime / 60);
    const seconds = currentTime % 60;
    pomodoroTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startTimer() {
    if (isRunning) return;
    
    isRunning = true;
    startTime = new Date();
    startPomodoro.disabled = true;
    pausePomodoro.disabled = false;
    
    pomodoroInterval = setInterval(() => {
        currentTime--;
        updateTimerDisplay();
        
        // XP hesapla (her saniye 0.0167 XP - 1 dakika = 1 XP)
        earnedXP += 0.0167;
        
        if (currentTime <= 0) {
            completeSession();
        }
    }, 1000);
}

function pauseTimer() {
    isRunning = false;
    clearInterval(pomodoroInterval);
    startPomodoro.disabled = false;
    pausePomodoro.disabled = true;
}

function resetTimer() {
    if (earnedXP > 0.0167) {
        saveEarnedXP();
    }
    
    pauseTimer();
    currentTime = selectedTime * 60;
    updateTimerDisplay();
    startPomodoro.disabled = false;
    pausePomodoro.disabled = true;
    earnedXP = 0;
}

function saveEarnedXP() {
    if (!currentUser) return;
    
    const userKey = `${currentUser.name}_${currentUser.surname}`;
    if (!userStats[userKey]) {
        userStats[userKey] = {
            monthlyXP: 0,
            monthlyStudyTime: 0,
            monthlySessions: 0,
            totalXP: 0,
            totalStudyTime: 0,
            totalSessions: 0,
            level: 1,
            currentStreak: 0,
            longestStreak: 0,
            lastStudyDate: null,
            joinDate: new Date().toLocaleString('tr-TR'),
            lastActive: new Date().toLocaleString('tr-TR')
        };
    }
    
    const roundedXP = Math.floor(earnedXP * 100) / 100;
    const roundedMinutes = Math.floor(earnedXP * 100) / 100;
    
    userStats[userKey].monthlyStudyTime = (userStats[userKey].monthlyStudyTime || 0) + roundedMinutes;
    userStats[userKey].monthlySessions = (userStats[userKey].monthlySessions || 0) + 1;
    userStats[userKey].monthlyXP = (userStats[userKey].monthlyXP || 0) + roundedXP;
    
    userStats[userKey].totalStudyTime = (userStats[userKey].totalStudyTime || 0) + roundedMinutes;
    userStats[userKey].totalSessions = (userStats[userKey].totalSessions || 0) + 1;
    userStats[userKey].totalXP = (userStats[userKey].totalXP || 0) + roundedXP;
    
    updateStreak();
    
    const newLevel = Math.floor((userStats[userKey].totalXP || 0) / 250) + 1;
    if (newLevel > (userStats[userKey].level || 1)) {
        userStats[userKey].level = newLevel;
    }
    
    localStorage.setItem('userStats', JSON.stringify(userStats));
    updatePomodoroStats();
    renderClass();
    renderLeaderboards();
    
    if (roundedXP >= 0.5) {
        alert(`⏱️ ${roundedMinutes.toFixed(1)} dakika kaydedildi!\n+${roundedXP.toFixed(1)} XP kazandın!`);
    }
}

function completeSession() {
    pauseTimer();
    
    if (!currentUser) return;
    
    const userKey = `${currentUser.name}_${currentUser.surname}`;
    if (!userStats[userKey]) {
        userStats[userKey] = {
            monthlyXP: 0,
            monthlyStudyTime: 0,
            monthlySessions: 0,
            totalXP: 0,
            totalStudyTime: 0,
            totalSessions: 0,
            level: 1,
            currentStreak: 0,
            longestStreak: 0,
            lastStudyDate: null,
            joinDate: new Date().toLocaleString('tr-TR'),
            lastActive: new Date().toLocaleString('tr-TR')
        };
    }
    
    userStats[userKey].monthlyStudyTime = (userStats[userKey].monthlyStudyTime || 0) + selectedTime;
    userStats[userKey].monthlySessions = (userStats[userKey].monthlySessions || 0) + 1;
    userStats[userKey].monthlyXP = (userStats[userKey].monthlyXP || 0) + selectedTime;
    
    userStats[userKey].totalStudyTime = (userStats[userKey].totalStudyTime || 0) + selectedTime;
    userStats[userKey].totalSessions = (userStats[userKey].totalSessions || 0) + 1;
    userStats[userKey].totalXP = (userStats[userKey].totalXP || 0) + selectedTime;
    
    updateStreak();
    
    const newLevel = Math.floor((userStats[userKey].totalXP || 0) / 250) + 1;
    if (newLevel > (userStats[userKey].level || 1)) {
        userStats[userKey].level = newLevel;
        alert(`🎉 Tebrikler! Seviye ${newLevel} oldunuz! 🎉`);
    }
    
    localStorage.setItem('userStats', JSON.stringify(userStats));
    updatePomodoroStats();
    renderClass();
    renderLeaderboards();
    
    alert('🎯 Oturum tamamlandı! 🎯\n' + 
          `+${selectedTime} XP kazandınız!\n` +
          `Toplam: ${userStats[userKey].totalXP || 0} XP`);
    
    resetTimer();
}

function updatePomodoroStats() {
    if (!currentUser) return;
    
    const userKey = `${currentUser.name}_${currentUser.surname}`;
    const stats = userStats[userKey];
    
    if (stats) {
        const totalXP = stats.totalXP || 0;
        const totalStudyTime = stats.totalStudyTime || 0;
        const monthlyXP = stats.monthlyXP || 0;
        const level = stats.level || 1;
        const currentStreak = stats.currentStreak || 0;
        
        totalStudyTimeEl.textContent = Math.floor(totalStudyTime);
        currentLevel.textContent = level;
        currentXP.textContent = Math.floor(totalXP);
        currentStreakEl.textContent = currentStreak;
        
        const currentLevelXP = (totalXP % 250) || 0;
        const xpPercentage = Math.min(100, Math.max(0, (currentLevelXP / 250) * 100));
        xpProgress.style.width = `${xpPercentage}%`;
        nextLevelXP.textContent = Math.max(0, 250 - currentLevelXP);
    } else {
        totalStudyTimeEl.textContent = "0";
        currentLevel.textContent = "1";
        currentXP.textContent = "0";
        currentStreakEl.textContent = "0";
        xpProgress.style.width = "0%";
        nextLevelXP.textContent = "250";
    }
}

function updateStreak() {
    if (!currentUser) return;
    
    const userKey = `${currentUser.name}_${currentUser.surname}`;
    const stats = userStats[userKey];
    if (!stats) return;
    
    const today = new Date().toDateString();
    const lastStudy = stats.lastStudyDate ? new Date(stats.lastStudyDate).toDateString() : null;
    
    const todayStudy = (stats.dailyStudyTime || 0) > 0;
    
    if (todayStudy) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toDateString();
        
        if (lastStudy === yesterdayStr) {
            stats.currentStreak = (stats.currentStreak || 0) + 1;
        } else if (lastStudy !== today) {
            stats.currentStreak = 1;
        }
        
        if (stats.currentStreak > (stats.longestStreak || 0)) {
            stats.longestStreak = stats.currentStreak;
        }
        
        stats.lastStudyDate = new Date().toISOString().split('T')[0];
        localStorage.setItem('userStats', JSON.stringify(userStats));
        updatePomodoroStats();
        renderClass();
    }
}

function checkMonthlyReset() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    const lastReset = localStorage.getItem('lastMonthlyReset');
    
    if (!lastReset) {
        resetMonthlyStats();
        localStorage.setItem('lastMonthlyReset', `${currentYear}-${currentMonth}`);
        return;
    }
    
    const [lastYear, lastMonth] = lastReset.split('-').map(Number);
    
    if (currentYear > lastYear || (currentYear === lastYear && currentMonth > lastMonth)) {
        resetMonthlyStats();
        localStorage.setItem('lastMonthlyReset', `${currentYear}-${currentMonth}`);
    }
}

function resetMonthlyStats() {
    Object.keys(userStats).forEach(userKey => {
        if (userStats[userKey]) {
            userStats[userKey].monthlyXP = 0;
            userStats[userKey].monthlyStudyTime = 0;
            userStats[userKey].monthlySessions = 0;
        }
    });
    localStorage.setItem('userStats', JSON.stringify(userStats));
    console.log('🔄 Aylık istatistikler sıfırlandı!');
}

// EVENT LISTENERS
// ===============

// Pomodoro event listeners
startPomodoro.addEventListener('click', startTimer);
pausePomodoro.addEventListener('click', pauseTimer);
resetPomodoro.addEventListener('click', resetTimer);

// Time options event listeners
timeOptions.forEach(option => {
    option.addEventListener('click', function() {
        timeOptions.forEach(opt => opt.classList.remove('active'));
        this.classList.add('active');
        selectedTime = parseInt(this.dataset.minutes);
        currentTime = selectedTime * 60;
        updateTimerDisplay();
    });
});

// İlk yükleme
updateTimerDisplay();

// Aylık sıfırlama kontrolü
setInterval(checkMonthlyReset, 60 * 60 * 1000);

</script>
</body>
</html>
